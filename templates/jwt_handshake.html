<!DOCTYPE html>
<html>

<head>
    <title>Loading...</title>
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f6f6f7;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .loader {
            text-align: center;
        }

        .spinner {
            border: 3px solid #e1e3e5;
            border-top: 3px solid #5c6ac4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .text {
            color: #637381;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="loader">
        <div class="spinner"></div>
        <div class="text">Authenticating...</div>
    </div>

    <script>
        // JWT Handshake Bridge - Handles cold entry/bookmarks/refreshes
        (async function () {
            try {
                // Get session token from App Bridge
                if (window.shopify && typeof window.shopify.idToken === 'function') {
                    const token = await window.shopify.idToken();

                    if (token) {
                        // Append token to current URL and reload
                        const url = new URL(window.location.href);
                        url.searchParams.set('id_token', token);

                        // Use replace to avoid back button issues
                        window.location.replace(url.toString());
                    } else {
                        throw new Error('Failed to obtain session token');
                    }
                } else {
                    throw new Error('App Bridge not available');
                }
            } catch (error) {
                console.error('JWT Handshake failed:', error);
                document.querySelector('.text').textContent = 'Authentication failed. Please reload.';
            }
        })();
    </script>
</body>

</html>