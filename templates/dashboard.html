<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Dashboard - Employee Suite</title>
    <!-- Shopify App Bridge - Latest version with proper initialization -->
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge/latest/environments/production.js"></script>

    <!-- Shopify Polaris Design System -->
    <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@10.0.0/build/esm/styles.css" />
    <script src="https://unpkg.com/@shopify/polaris@10.0.0/build/esm/polaris.min.js"></script>
    <script>
        // Enhanced App Bridge initialization with error handling
        (function () {
            var urlParams = new URLSearchParams(window.location.search);
            var host = urlParams.get("host");
            var shop = urlParams.get("shop");

            window.appBridgeReady = false;
            window.isEmbedded = !!host;
            window.appBridgeReadyPromise = new Promise(function (resolve) {
                window.appBridgeReadyResolve = resolve;
            });

            if (!host) {
                window.shopifyApp = null;
                window.appBridgeReady = true;
                if (window.appBridgeReadyResolve) {
                    window.appBridgeReadyResolve({
                        ready: true,
                        embedded: false,
                        app: null,
                    });
                }
                return;
            }

            // App Bridge v4 with timeout and error handling
            var initAttempts = 0;
            var maxAttempts = 50; // 5 seconds max

            function init() {
                initAttempts++;

                if (window.shopify) {
                    window.shopifyApp = window.shopify;
                    window.appBridgeReady = true;
                    if (window.appBridgeReadyResolve) {
                        window.appBridgeReadyResolve({
                            ready: true,
                            embedded: true,
                            app: window.shopify,
                        });
                    }
                    return;
                }

                if (initAttempts >= maxAttempts) {
                    console.warn(
                        "App Bridge initialization timeout - falling back to cookie auth",
                    );
                    window.appBridgeReady = true;
                    if (window.appBridgeReadyResolve) {
                        window.appBridgeReadyResolve({
                            ready: false,
                            embedded: true,
                            app: null,
                        });
                    }
                    return;
                }

                setTimeout(init, 100);
            }
            init();
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Critical: Prevent any blocking - render immediately -->
    <style>
        /* Inline critical CSS - no blocking */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
    </style>
    <!-- Defer non-critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Shopify Polaris CSS - only load in embedded mode -->
    <script>
        // App Bridge CSS removed - it's optional and the file doesn't exist at the CDN URL
        // App Bridge JavaScript provides all necessary functionality without CSS
    </script>
    <!-- External Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <style>
        /* Critical overrides only */
        body {
            margin: 0;
            padding: 0;
        }

        /* Hide header when embedded */
        body.embedded .header {
            display: none !important;
        }

        body.embedded footer {
            display: none !important;
        }
    </style>

    <!-- Consolidated App Bridge moved to top of head -->

    <!-- Google Analytics - Load after page renders -->
    <script>
        // Defer analytics loading
        window.addEventListener("load", function () {
            var script = document.createElement("script");
            script.async = true;
            script.src =
                "https://www.googletagmanager.com/gtag/js?id=G-RBBQ4X7FJ3";
            document.head.appendChild(script);

            script.onload = function () {
                window.dataLayer = window.dataLayer || [];
                function gtag() {
                    dataLayer.push(arguments);
                }
                gtag("js", new Date());
                gtag("config", "G-RBBQ4X7FJ3");
            };
        });
    </script>

    <!-- Meta tags for better SEO and sharing -->
    <meta name="description"
        content="Monitor your Shopify store operations with order tracking, inventory management, and revenue analytics." />
    <meta name="keywords" content="shopify, automation, inventory, orders, analytics, ecommerce" />
    <meta property="og:title" content="Employee Suite - Shopify Automation Platform" />
    <meta property="og:description"
        content="Automate order processing, inventory management, and revenue reporting for your Shopify store." />
    <meta property="og:type" content="website" />
    <script>
        // CRITICAL: Robust navigation helper to preserve embedded context (v2.0 - Forced Update)
        window.openPage = function (path) {
            var params = new URLSearchParams(window.location.search);
            var shop = params.get("shop");
            var host = params.get("host");
            var embedded = params.get("embedded") || (host ? "1" : "");

            var sep = path.indexOf("?") > -1 ? "&" : "?";
            var dest = path;

            if (shop) dest += sep + "shop=" + shop;
            if (host)
                dest +=
                    (dest.indexOf("?") > -1 ? "&" : "?") + "host=" + host;
            if (embedded)
                dest +=
                    (dest.indexOf("?") > -1 ? "&" : "?") +
                    "embedded=" +
                    embedded;

            // Navigate properly
            window.location.href = dest;
            return false;
        };
    </script>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <a href="#" onclick="
                        openPage('/dashboard');
                        return false;
                    " style="
                        text-decoration: none;
                        color: inherit;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        font-weight: 600;
                    " class="logo">
                <span>Employee Suite</span>
            </a>
            <div class="header-nav">
                <div class="quick-menu">
                    <button class="quick-menu-btn" onclick="toggleQuickMenu(event)">
                        ‚ö° Quick Access
                    </button>
                    <div class="quick-menu-dropdown" id="quickMenu">
                        <a href="#" onclick="
                                    openPage('/features/csv-exports');
                                    return false;
                                " class="quick-menu-item">
                            <span class="quick-menu-item-icon">üì•</span>
                            CSV Exports
                            <span class="quick-menu-shortcut">‚åòE</span>
                        </a>
                        <a href="#" onclick="
                                    openPage('/features/scheduled-reports');
                                    return false;
                                " class="quick-menu-item">
                            <span class="quick-menu-item-icon">üìÖ</span>
                            Scheduled Reports
                            <span class="quick-menu-shortcut">‚åòS</span>
                        </a>
                        <a href="#" onclick="
                                    openPage('/features/dashboard');
                                    return false;
                                " class="quick-menu-item">
                            <span class="quick-menu-item-icon">üìä</span>
                            Comprehensive Dashboard
                            <span class="quick-menu-shortcut">‚åòD</span>
                        </a>
                        <a href="#" onclick="
                                    openPage('/features/welcome');
                                    return false;
                                " class="quick-menu-item">
                            <span class="quick-menu-item-icon">üéâ</span>
                            New Features
                        </a>
                        <div style="
                                    border-top: 1px solid #e1e3e5;
                                    margin: 8px 0;
                                "></div>
                        <a href="#" onclick="
                                    openPage('/settings/shopify');
                                    return false;
                                " class="quick-menu-item">
                            <span class="quick-menu-item-icon">‚öôÔ∏è</span>
                            Settings
                            <span class="quick-menu-shortcut">‚åò,</span>
                        </a>
                        <a href="#" onclick="
                                    openPage('/subscribe');
                                    return false;
                                " class="quick-menu-item">
                            <span class="quick-menu-item-icon">üí≥</span>
                            Subscribe
                        </a>
                    </div>
                </div>
                <a href="#" onclick="
                            openPage('/settings/shopify');
                            return false;
                        " class="nav-btn">Settings</a>
                <a href="#" onclick="
                            openPage('/subscribe');
                            return false;
                        " class="nav-btn nav-btn-primary">Subscribe</a>
                <a href="/logout" class="nav-btn">Logout</a>
            </div>
        </div>
    </div>

    <div class="page-wrapper">
        <div class="container">
            <div class="dashboard-header-row">
                <div>
                    <div class="page-title">Dashboard</div>
                    <div class="page-subtitle">
                        Monitor your Shopify store operations with inventory
                        tracking, order monitoring, and comprehensive revenue
                        analytics. 7-day free trial, no setup fees.
                    </div>
                    <div style="
                            margin-top: 16px;
                            display: flex;
                            gap: 12px;
                            flex-wrap: wrap;
                        ">
                        <a href="#" onclick="
                                openPage('/features/welcome');
                                return false;
                            " class="btn-primary">
                            üéâ Explore New Features ‚Üí
                        </a>
                        <a href="#" onclick="
                                openPage('/features/csv-exports');
                                return false;
                            " class="btn-secondary">
                            üì• Export Data
                        </a>
                        <a href="#" onclick="
                                openPage('/features/dashboard');
                                return false;
                            " class="btn-secondary">
                            üìä Full Dashboard
                        </a>
                    </div>
                </div>
                {% if is_subscribed %}
                <div style="
                        background: #fff;
                        border: 1px solid #e5e5e5;
                        border-radius: 16px;
                        padding: 16px 20px;
                        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                        text-align: center;
                        min-width: 140px;
                    ">
                    <div style="
                            font-size: 11px;
                            color: #737373;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 4px;
                        ">
                        Subscribed
                    </div>
                    <div style="
                            font-size: 20px;
                            font-weight: 700;
                            color: #0a0a0a;
                        ">
                        ‚úì Active
                    </div>
                </div>
                {% endif %}
            </div>

            {% if not has_access %}
            <div class="banner banner-warning" style="justify-content: space-between; align-items: center">
                <div class="banner-content">
                    <h3>Subscription Required</h3>
                    <p>
                        Your trial has ended. Subscribe now to continue using
                        Employee Suite.
                    </p>
                </div>
                <a href="#" onclick="
                        openPage('/subscribe');
                        return false;
                    " class="banner-action">Subscribe Now</a>
            </div>
            {% elif trial_active and not is_subscribed %}
            <div class="banner banner-warning" style="justify-content: space-between; align-items: center">
                <div class="banner-content">
                    <h3>
                        ‚è∞ Trial Active - {{ days_left }} day{{ 's' if days_left
                        != 1 else '' }} remaining
                    </h3>
                    <p>
                        Subscribe now to keep access when your trial ends. No
                        credit card required until trial ends.
                    </p>
                </div>
                <a href="{{ url_for('billing.subscribe') }}" class="banner-action">Subscribe Now ‚Üí</a>
            </div>
            {% endif %} {% if has_shopify and quick_stats.has_data and
            is_subscribed %}
            <!-- PREMIUM: PROPRIETARY FORECASTING ENGINE ($99/mo Value) -->
            <div id="executive-insights" style="
                    margin-bottom: 32px;
                    display: none;
                    animation: fadeIn 0.6s ease-out;
                ">
                <div style="
                        background: linear-gradient(
                            135deg,
                            #0f172a 0%,
                            #1e293b 100%
                        );
                        color: white;
                        border-radius: 16px;
                        padding: 24px;
                        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
                        position: relative;
                        overflow: hidden;
                        border: 1px solid rgba(255, 255, 255, 0.05);
                    ">
                    <!-- Background decoration -->
                    <div style="
                            position: absolute;
                            top: -50px;
                            right: -50px;
                            width: 300px;
                            height: 300px;
                            background: radial-gradient(
                                circle,
                                rgba(99, 102, 241, 0.2) 0%,
                                rgba(0, 0, 0, 0) 70%
                            );
                            pointer-events: none;
                        "></div>
                    <div style="
                            position: absolute;
                            bottom: -50px;
                            left: -50px;
                            width: 200px;
                            height: 200px;
                            background: radial-gradient(
                                circle,
                                rgba(16, 185, 129, 0.1) 0%,
                                rgba(0, 0, 0, 0) 70%
                            );
                            pointer-events: none;
                        "></div>

                    <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            position: relative;
                            z-index: 2;
                            flex-wrap: wrap;
                            gap: 20px;
                        ">
                        <div>
                            <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    margin-bottom: 12px;
                                ">
                                <span style="
                                        background: rgba(99, 102, 241, 0.2);
                                        color: #a5b4fc;
                                        font-size: 11px;
                                        font-weight: 700;
                                        padding: 4px 8px;
                                        border-radius: 4px;
                                        text-transform: uppercase;
                                        letter-spacing: 1px;
                                        border: 1px solid
                                            rgba(99, 102, 241, 0.3);
                                    ">AI Forecast</span>
                                <span style="
                                        color: #94a3b8;
                                        font-size: 13px;
                                        font-weight: 500;
                                    ">Inventory Intelligence</span>
                            </div>
                            <h2 style="
                                    font-size: 24px;
                                    font-weight: 700;
                                    color: white;
                                    margin-bottom: 8px;
                                    letter-spacing: -0.5px;
                                    line-height: 1.2;
                                ">
                                Stockout Risk Detected
                            </h2>
                            <p style="
                                    color: #cbd5e1;
                                    font-size: 14px;
                                    max-width: 550px;
                                    line-height: 1.6;
                                ">
                                Our predictive engine analyzed your recent sales
                                velocity.
                                <strong id="risk-count" style="color: white; font-weight: 600">-- items</strong>
                                are projected to run out of stock within the
                                next 7 days.
                            </p>
                        </div>
                        <div style="
                                text-align: right;
                                background: rgba(0, 0, 0, 0.2);
                                padding: 12px 16px;
                                border-radius: 12px;
                                border: 1px solid rgba(255, 255, 255, 0.05);
                            ">
                            <div style="
                                    font-size: 12px;
                                    color: #94a3b8;
                                    margin-bottom: 4px;
                                    font-weight: 500;
                                ">
                                Potential Revenue Loss
                            </div>
                            <div id="risk-revenue" style="
                                    font-size: 28px;
                                    font-weight: 700;
                                    color: #f87171;
                                    letter-spacing: -1px;
                                    line-height: 1;
                                ">
                                --
                            </div>
                        </div>
                    </div>

                    <!-- Risk Items Table -->
                    <div style="
                            margin-top: 24px;
                            background: rgba(255, 255, 255, 0.03);
                            border-radius: 12px;
                            overflow: hidden;
                            border: 1px solid rgba(255, 255, 255, 0.05);
                        ">
                        <div style="
                                padding: 12px 16px;
                                background: rgba(255, 255, 255, 0.02);
                                border-bottom: 1px solid
                                    rgba(255, 255, 255, 0.05);
                                font-size: 11px;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                                color: #64748b;
                                font-weight: 600;
                                display: flex;
                                justify-content: space-between;
                            ">
                            <span>High Risk Items</span>
                            <span>Projection</span>
                        </div>
                        <div id="risk-list" style="display: flex; flex-direction: column">
                            <!-- JS injected items here -->
                            <div style="
                                    text-align: center;
                                    color: #94a3b8;
                                    font-size: 13px;
                                    padding: 20px;
                                ">
                                Analyzing sales patterns...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                // Fetch AI Forecast - Only if subscribed
                document.addEventListener('DOMContentLoaded', function () {
                    var isSubscribed = {{ "true" if is_subscribed else "false" }
                };
                if (!isSubscribed) return;

                var shopParam = '{{ shop or "" }}';
                var fetchUrl = '/api/analytics/forecast' + (shopParam ? '?shop=' + encodeURIComponent(shopParam) : '');

                fetch(fetchUrl)
                    .then(function (r) { return r.json(); })
                    .then(function (data) {
                        if (data.metrics && data.metrics.at_risk_count > 0) {
                            var container = document.getElementById('executive-insights');
                            if (container) {
                                container.style.display = 'block';
                                document.getElementById('risk-count').innerText = data.metrics.at_risk_count + ' items';

                                // Format currency
                                var formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
                                document.getElementById('risk-revenue').innerText = formatter.format(data.metrics.total_potential_loss);

                                // Render items
                                var list = document.getElementById('risk-list');
                                list.innerHTML = '';

                                data.items.forEach(function (item, index) {
                                    // Only show top 3 to keep it compact
                                    if (index >= 3) return;

                                    var borderStyle = index < Math.min(data.items.length, 3) - 1 ? 'border-bottom: 1px solid rgba(255,255,255,0.05);' : '';

                                    var row = '<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; ' + borderStyle + ' transition: background 0.2s;" onmouseover="this.style.background=\\'rgba(255, 255, 255, 0.05) \\'" onmouseout="this.style.background=\\'transparent\\'">';
                                    row += '<div>';
                                    row += '<div style="color: white; font-weight: 500; font-size: 14px;">' + item.product_title + '</div>';
                                    row += '<div style="color: #94a3b8; font-size: 12px; margin-top: 2px;">Velocity: ' + item.velocity + '</div>';
                                    row += '</div>';
                                    row += '<div style="text-align: right;">';
                                    row += '<div style="color: #f87171; font-weight: 600; font-size: 13px;">' + item.days_remaining + ' days left</div>';
                                    row += '<div style="color: #64748b; font-size: 11px; margin-top: 2px;">Stock: ' + item.current_stock + '</div>';
                                    row += '</div>';
                                    row += '</div>';
                                    list.innerHTML += row;
                                });

                                if (data.items.length > 3) {
                                    list.innerHTML += '<div style="padding: 10px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05);"><a href="/features/dashboard" style="color: #a5b4fc; font-size: 12px; text-decoration: none;">View all ' + data.metrics.at_risk_count + ' risks ‚Üí</a></div>';
                                }
                            }
                        }
                    })
                    .catch(function (e) { console.error("Forecast error:", e); });
                });
            </script>
            {% endif %} {% if has_shopify and quick_stats.has_data and
            is_subscribed %}
            <div style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 16px;
                    margin-bottom: 32px;
                    animation: fadeIn 0.5s ease-in;
                ">
                <div class="stat-card">
                    <div style="
                            font-size: 13px;
                            color: #737373;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 12px;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">
                        <span>üì¶</span>
                        <span>Pending Orders</span>
                    </div>
                    <div style="
                            font-size: 40px;
                            font-weight: 800;
                            color: #0a0a0a;
                            line-height: 1;
                            margin-bottom: 8px;
                        ">
                        {{ quick_stats.pending_orders or 0 }}
                    </div>
                    <div style="font-size: 13px; color: #737373">
                        Need your attention
                    </div>
                </div>
                <div style="
                        background: linear-gradient(
                            135deg,
                            #fff 0%,
                            #fafafa 100%
                        );
                        border: 1px solid #e5e5e5;
                        border-radius: 16px;
                        padding: 24px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
                        transition: all 0.3s ease;
                    ">
                    <div style="
                            font-size: 13px;
                            color: #737373;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 12px;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">
                        <span>üìä</span>
                        <span>Total Products</span>
                    </div>
                    <div style="
                            font-size: 40px;
                            font-weight: 800;
                            color: #0a0a0a;
                            line-height: 1;
                            margin-bottom: 8px;
                        ">
                        {{ quick_stats.total_products or 0 }}
                    </div>
                    <div style="font-size: 13px; color: #737373">
                        In your store
                    </div>
                </div>
                <div style="
                        background: linear-gradient(
                            135deg,
                            #fff 0%,
                            #fafafa 100%
                        );
                        border: 1px solid #e5e5e5;
                        border-radius: 16px;
                        padding: 24px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
                        transition: all 0.3s ease;
                    ">
                    <div style="
                            font-size: 13px;
                            color: #737373;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-bottom: 12px;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">
                        <span>‚ö†Ô∏è</span>
                        <span>Low Stock</span>
                    </div>
                    <div
                        style="font-size: 40px; font-weight: 800; color: {% if quick_stats.low_stock_items > 0 %}#dc2626{% else %}#16a34a{% endif %}; line-height: 1; margin-bottom: 8px;">
                        {{ quick_stats.low_stock_items or 0 }}
                    </div>
                    <div style="font-size: 13px; color: #737373">
                        {% if quick_stats.low_stock_items > 0 %}Need
                        restocking{% else %}All good{% endif %}
                    </div>
                </div>
            </div>
            {% endif %} {% if not has_shopify %}
            <div class="banner banner-info" style="
                    background: #ffffff;
                    border: 1px solid #e1e3e5;
                    border-left: 3px solid #008060;
                ">
                <div class="banner-content" style="flex: 1">
                    <h3 style="
                            margin-bottom: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            color: #202223;
                        ">
                        Connect your Shopify store
                    </h3>
                    <p style="
                            margin-bottom: 0;
                            font-size: 14px;
                            color: #6d7175;
                        ">
                        Get started in 30 seconds. Connect your store to unlock
                        order monitoring, inventory management, and revenue
                        analytics.
                    </p>
                </div>
                <a href="#" onclick="
                        openPage('/settings/shopify');
                        return false;
                    " class="banner-action">Connect Store ‚Üí</a>
            </div>
            {% endif %}

            <div class="cards-grid">
                <div class="card">
                    <div class="card-icon">üì¶</div>
                    <div class="card-title">Order Processing</div>
                    <div class="card-description">
                        View pending and unfulfilled Shopify orders. Monitor
                        order status and payment information.
                    </div>
                    {% if has_access %}
                    <button type="button" class="card-btn" data-action="processOrders" onclick="
                            if (window.processOrders)
                                window.processOrders(this);
                        " aria-label="View pending orders">
                        <span>View Orders</span>
                        <span style="font-size: 12px; opacity: 0.8">‚Üí</span>
                    </button>
                    {% else %}
                    <button type="button" class="card-btn" onclick="showSubscribePrompt()"
                        style="opacity: 0.6; cursor: not-allowed" disabled aria-label="Subscribe to view orders">
                        <span>View Orders</span>
                        <span style="font-size: 12px; opacity: 0.8">‚Üí</span>
                    </button>
                    {% endif %}
                </div>

                <div class="card">
                    <div class="card-icon">üìä</div>
                    <div class="card-title">Inventory Management</div>
                    <div class="card-description">
                        Monitor stock levels across all products. Get low-stock
                        alerts and complete inventory visibility.
                    </div>
                    {% if has_access %}
                    <button type="button" class="card-btn" data-action="updateInventory" onclick="
                            if (window.updateInventory)
                                window.updateInventory(this);
                        " aria-label="Check inventory levels">
                        <span>Check Inventory</span>
                        <span style="font-size: 12px; opacity: 0.8">‚Üí</span>
                    </button>
                    {% else %}
                    <button type="button" class="card-btn" onclick="showSubscribePrompt()"
                        style="opacity: 0.6; cursor: not-allowed" disabled aria-label="Subscribe to check inventory">
                        <span>Check Inventory</span>
                        <span style="font-size: 12px; opacity: 0.8">‚Üí</span>
                    </button>
                    {% endif %}
                </div>

                <div class="card">
                    <div class="card-icon">üí∞</div>
                    <div class="card-title">Revenue Analytics</div>
                    <div class="card-description">
                        Generate revenue reports with product-level breakdown
                        and insights.
                    </div>
                    {% if has_access %}
                    <button type="button" class="card-btn" data-action="generateReport" onclick="
                            if (window.generateReport)
                                window.generateReport(this);
                        " aria-label="Generate revenue report">
                        <span>Generate Report</span>
                        <span style="font-size: 12px; opacity: 0.8">‚Üí</span>
                    </button>
                    {% else %}
                    <button type="button" class="card-btn" onclick="showSubscribePrompt()"
                        style="opacity: 0.6; cursor: not-allowed" disabled aria-label="Subscribe to generate reports">
                        <span>Generate Report</span>
                        <span style="font-size: 12px; opacity: 0.8">‚Üí</span>
                    </button>
                    {% endif %}
                </div>

                <div class="card" style="
                        border: 2px solid #008060;
                        background: linear-gradient(
                            135deg,
                            #ffffff 0%,
                            #f0fdf4 100%
                        );
                    ">
                    <div style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                        <div class="card-icon">üì•</div>
                        <span style="
                                background: #008060;
                                color: white;
                                padding: 2px 8px;
                                border-radius: 4px;
                                font-size: 11px;
                                font-weight: 600;
                            ">NEW</span>
                    </div>
                    <div class="card-title">CSV Exports</div>
                    <div class="card-description">
                        Download Orders, Inventory, and Revenue reports as CSV
                        with date filtering. Export your data anytime.
                    </div>
                    {% if has_access %}
                    <a href="/features/csv-exports{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{% endif %}{% endif %}"
                        class="card-btn" style="
                            text-decoration: none;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: #008060;
                            color: white;
                        ">
                        <span>Export Data</span>
                        <span style="font-size: 12px; opacity: 0.9">‚Üí</span>
                    </a>
                    {% else %}
                    <a href="/features/welcome{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{% endif %}{% endif %}"
                        class="card-btn" style="
                            text-decoration: none;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: #008060;
                            color: white;
                        ">
                        <span>Learn More</span>
                        <span style="font-size: 12px; opacity: 0.9">‚Üí</span>
                    </a>
                    {% endif %}
                </div>

                <div class="card" style="
                        border: 2px solid #008060;
                        background: linear-gradient(
                            135deg,
                            #ffffff 0%,
                            #f0fdf4 100%
                        );
                    ">
                    <div style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                        <div class="card-icon">üìÖ</div>
                        <span style="
                                background: #008060;
                                color: white;
                                padding: 2px 8px;
                                border-radius: 4px;
                                font-size: 11px;
                                font-weight: 600;
                            ">NEW</span>
                    </div>
                    <div class="card-title">Scheduled Reports</div>
                    <div class="card-description">
                        Automatically receive reports via Email or SMS at your
                        preferred time. Set it and forget it.
                    </div>
                    {% if has_access %}
                    <a href="/features/scheduled-reports{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{% endif %}{% endif %}"
                        class="card-btn" style="
                            text-decoration: none;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: #008060;
                            color: white;
                        ">
                        <span>Schedule Reports</span>
                        <span style="font-size: 12px; opacity: 0.9">‚Üí</span>
                    </a>
                    {% else %}
                    <a href="/features/welcome{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{% endif %}{% endif %}"
                        class="card-btn" style="
                            text-decoration: none;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: #008060;
                            color: white;
                        ">
                        <span>Learn More</span>
                        <span style="font-size: 12px; opacity: 0.9">‚Üí</span>
                    </a>
                    {% endif %}
                </div>

                <div class="card" style="
                        border: 2px solid #008060;
                        background: linear-gradient(
                            135deg,
                            #ffffff 0%,
                            #f0fdf4 100%
                        );
                    ">
                    <div style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            margin-bottom: 8px;
                        ">
                        <div class="card-icon">üìä</div>
                        <span style="
                                background: #008060;
                                color: white;
                                padding: 2px 8px;
                                border-radius: 4px;
                                font-size: 11px;
                                font-weight: 600;
                            ">NEW</span>
                    </div>
                    <div class="card-title">Comprehensive Dashboard</div>
                    <div class="card-description">
                        View all three reports (Orders, Inventory, Revenue) in
                        one unified dashboard view.
                    </div>
                    {% if has_access %}
                    <a href="/features/dashboard{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{% endif %}{% endif %}"
                        class="card-btn" style="
                            text-decoration: none;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: #008060;
                            color: white;
                        ">
                        <span>View Dashboard</span>
                        <span style="font-size: 12px; opacity: 0.9">‚Üí</span>
                    </a>
                    {% else %}
                    <a href="/features/welcome{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{% endif %}{% endif %}"
                        class="card-btn" style="
                            text-decoration: none;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            background: #008060;
                            color: white;
                        ">
                        <span>Learn More</span>
                        <span style="font-size: 12px; opacity: 0.9">‚Üí</span>
                    </a>
                    {% endif %}
                </div>
            </div>

            <div id="connection-status" style="display: none; margin-bottom: 16px"></div>
            <div class="output-container">
                <div class="output-header">Results</div>
                <div id="output"></div>
            </div>
        </div>

        <script>
            // ============================================================================
            // COMPREHENSIVE JAVASCRIPT ERROR LOGGING - Capture EVERY error crumb
            // ============================================================================

            // CRITICAL: Store original console.error BEFORE intercepting it
            // This prevents infinite recursion when logJavaScriptError uses console.error
            var originalConsoleError = console.error;

            // Guard flag to prevent recursive logging
            var isLoggingError = false;

            // Function to log JavaScript errors to backend
            // CRITICAL: Prevent recursive error logging
            var isLoggingError = false;
            var logErrorAttempts = 0;
            var maxLogAttempts = 3;

            function logJavaScriptError(errorType, errorMessage, errorLocation, errorData, stackTrace) {
                // Prevent infinite recursion
                if (isLoggingError || logErrorAttempts >= maxLogAttempts) {
                    originalConsoleError.call(console, '[ERROR LOGGING BLOCKED]', errorType, ':', errorMessage);
                    return;
                }

                // Skip logging errors about logging
                if (errorMessage && (errorMessage.includes('log_error') || errorMessage.includes('Failed to log error'))) {
                    originalConsoleError.call(console, '[RECURSIVE ERROR IGNORED]', errorMessage);
                    return;
                }

                isLoggingError = true;
                logErrorAttempts++;

                try {
                    var errorLog = {
                        timestamp: new Date().toISOString(),
                        error_type: errorType,
                        error_message: errorMessage,
                        error_location: errorLocation,
                        stack_trace: stackTrace,
                        error_data: errorData || {},
                        user_agent: navigator.userAgent,
                        url: window.location.href,
                        referer: document.referrer,
                        session_id: 'js-session-' + Date.now()
                    };

                    // Use relative URL to avoid CORS issues
                    fetch('/api/log_error', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'  // CSRF bypass
                        },
                        body: JSON.stringify(errorLog),
                        credentials: 'include'
                    }).catch(function (err) {
                        // CRITICAL: Don't log fetch errors to prevent recursion
                        originalConsoleError.call(console, 'Error logging failed (ignored to prevent recursion)');
                    }).finally(function () {
                        isLoggingError = false;
                    });

                    originalConsoleError.call(console, '[ERROR LOGGED]', errorType, ':', errorMessage);
                } catch (e) {
                    originalConsoleError.call(console, 'Error logging system failed:', e);
                } finally {
                    isLoggingError = false;
                }
            }

            // Global error handler - catches ALL unhandled errors
            window.addEventListener('error', function (event) {
                logJavaScriptError(
                    'JavaScriptError',
                    event.message || 'Unknown error',
                    event.filename + ':' + event.lineno + ':' + event.colno,
                    {
                        error: event.error ? event.error.toString() : null,
                        type: event.type,
                        target: event.target ? event.target.tagName : null
                    },
                    event.error ? (event.error.stack || 'No stack trace') : 'No stack trace'
                );
            }, true); // Use capture phase to catch all errors

            // Unhandled promise rejection handler - Enhanced to prevent freezing
            window.addEventListener('unhandledrejection', function (event) {
                var error = event.reason;
                var errorMessage = error ? (error.message || error.toString() || 'Unhandled promise rejection') : 'Unknown promise rejection';
                var stackTrace = error && error.stack ? error.stack : 'No stack trace';

                // Use originalConsoleError to prevent recursion
                originalConsoleError.call(console, '‚ùå Unhandled promise rejection:', error);
                originalConsoleError.call(console, 'This may cause the application to freeze. Error:', errorMessage);

                logJavaScriptError(
                    'UnhandledPromiseRejection',
                    errorMessage,
                    'Promise rejection',
                    {
                        reason: error ? error.toString() : null,
                        promise: event.promise ? event.promise.toString() : null
                    },
                    stackTrace
                );

                // Prevent default browser error handling and application freeze
                event.preventDefault();

                // Show user-friendly error message if possible
                try {
                    var outputEl = document.getElementById('output');
                    if (outputEl) {
                        outputEl.innerHTML = '<div style="padding: 20px; background: #fff4f4; border: 1px solid #fecaca; border-radius: 8px;"><div style="font-size: 15px; font-weight: 600; color: #d72c0d; margin-bottom: 8px;">‚ö†Ô∏è An error occurred</div><div style="font-size: 14px; color: #6d7175;">Please refresh the page and try again.</div></div>';
                    }
                } catch (e) {
                    // If showing error fails, use originalConsoleError to prevent recursion
                    originalConsoleError.call(console, 'Failed to show error message:', e);
                }
            });

            // Console error interceptor (catches console.error calls)
            // CRITICAL: originalConsoleError is already defined above to prevent recursion
            console.error = function () {
                var args = Array.prototype.slice.call(arguments);

                // Skip logging if we're already in the middle of logging (prevents recursion)
                if (isLoggingError) {
                    // Just call original and return immediately
                    originalConsoleError.apply(console, args);
                    return;
                }

                var errorMessage = args.map(function (arg) {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg);
                        } catch (e) {
                            return arg.toString();
                        }
                    }
                    return String(arg);
                }).join(' ');

                // Check if this is a log from our own error logging system (prevent recursion)
                if (errorMessage.includes('[ERROR LOGGED]') ||
                    errorMessage.includes('Failed to log error to backend') ||
                    errorMessage.includes('Error logging system failed')) {
                    // This is our own logging, just call original and return
                    originalConsoleError.apply(console, args);
                    return;
                }

                logJavaScriptError(
                    'ConsoleError',
                    errorMessage,
                    'console.error',
                    { arguments: args },
                    new Error().stack || 'No stack trace'
                );

                // Call original console.error
                originalConsoleError.apply(console, args);
            };

            // Try-catch wrapper for async functions
            window.addEventListener('unhandledrejection', function (event) {
                // Already handled above, but ensure we catch everything
            });

            // ============================================================================
            // END COMPREHENSIVE JAVASCRIPT ERROR LOGGING
            // ============================================================================

            // Handle resource loading errors gracefully
            window.addEventListener('error', function (e) {
                // Skip logging for missing static resources to reduce noise
                if (e.target && (e.target.tagName === 'LINK' || e.target.tagName === 'SCRIPT')) {
                    console.warn('Resource failed to load:', e.target.src || e.target.href);
                    return; // Don't log to backend
                }
            }, true);

            // Early function check - verify functions will be available (before definitions)
            console.log('üîç Early function check (before definitions):', {
                processOrders: typeof window.processOrders,
                updateInventory: typeof window.updateInventory,
                generateReport: typeof window.generateReport
            });
            // Professional request management - prevent duplicate requests and cancel previous ones
            var activeRequests = {
                processOrders: null,
                updateInventory: null,
                generateReport: null
            };

            // Debounce timers to prevent rapid clicks
            var debounceTimers = {
                processOrders: null,
                updateInventory: null,
                generateReport: null
            };

            // Get APP_URL from template or use current origin (FIXED: was using template literal incorrectly)
            var APP_URL = '{{ APP_URL|default("") }}' || window.location.origin;

            // CRITICAL: Extract shop, host, and id_token from URL for API calls
            var urlParams = new URLSearchParams(window.location.search);
            var SHOP_PARAM = urlParams.get('shop') || '';
            var HOST_PARAM = urlParams.get('host') || '';
            var ID_TOKEN = urlParams.get('id_token') || '';

            // Store in window for global access
            window.SHOP_PARAM = SHOP_PARAM;
            window.HOST_PARAM = HOST_PARAM;
            window.ID_TOKEN = ID_TOKEN;

            console.log('Shop params loaded:', { shop: SHOP_PARAM, hasIdToken: !!ID_TOKEN });

            // Network status detection with visual indicator
            var isOnline = navigator.onLine;
            function updateConnectionStatus() {
                var statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    if (isOnline) {
                        statusEl.style.display = 'none';
                    } else {
                        statusEl.style.display = 'block';
                        statusEl.innerHTML = '<div style="padding: 8px 16px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 6px; font-size: 13px; color: #202223; text-align: center;">‚ö†Ô∏è No internet connection</div>';
                    }
                }
            }

            window.addEventListener('online', function () {
                isOnline = true;
                // Connection restored
                updateConnectionStatus();
                // Show success message
                var statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.style.display = 'block';
                    statusEl.innerHTML = '<div style="padding: 8px 16px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; font-size: 13px; color: #166534; text-align: center;">‚úÖ Connection restored</div>';
                    setTimeout(function () {
                        statusEl.style.display = 'none';
                    }, 3000);
                }
            });
            window.addEventListener('offline', function () {
                isOnline = false;
                // Connection lost
                updateConnectionStatus();
            });

            // Cancel previous request if user clicks another button
            function cancelPreviousRequest(requestType) {
                if (activeRequests[requestType] && activeRequests[requestType].abort) {
                    activeRequests[requestType].abort();
                    activeRequests[requestType] = null;
                }
            }

            // Debounce function to prevent rapid clicks (professional standard)
            function debounce(func, requestType, delay) {
                return function () {
                    var context = this;
                    var args = arguments;

                    // Cancel previous timer
                    if (debounceTimers[requestType]) {
                        clearTimeout(debounceTimers[requestType]);
                    }

                    // Set new timer
                    debounceTimers[requestType] = setTimeout(function () {
                        func.apply(context, args);
                        debounceTimers[requestType] = null;
                    }, delay);
                };
            }

            function showSubscribePrompt() {
                document.getElementById('output').innerHTML = `
                            <div style="padding: 40px; background: #fff; border-radius: 16px; border: 1px solid #e5e7eb; text-align: center; animation: fadeIn 0.3s ease-in; max-width: 500px; margin: 0 auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                                <div style="margin-bottom: 20px; display: inline-flex; align-items: center; justify-content: center; width: 64px; height: 64px; background: #FEF2F2; border-radius: 50%;">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                    </svg>
                                </div>
                                <h3 style="color: #111827; margin-bottom: 8px; font-size: 20px; font-weight: 700;">Subscription Required</h3>
                                <p style="color: #6B7280; margin-bottom: 24px; font-size: 15px; line-height: 1.5;">This feature is available with Employee Suite Pro. Subscribe to unlock full access.</p>
                                <a href="/subscribe?shop={{ shop }}{% if host %}&host={{ host }}{% endif %}" style="display: inline-block; background: #2563EB; color: #fff; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px; transition: all 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">Upgrade Now ‚Üí</a>
                                <p style="color: #9CA3AF; margin-top: 16px; font-size: 13px;">$39/month ‚Ä¢ 7-day money-back guarantee</p>
                            </div>
                        `;
            }

            function showLoading(message = 'Processing...') {
                // Professional skeleton loading state (like top Shopify apps)
                document.getElementById('output').innerHTML = `
                            <div class="loading">
                                <div class="spinner"></div>
                                <div class="loading-text">${message}</div>
                                <div style="margin-top: 16px; font-size: 12px; color: #8c9196;">This may take a few moments...</div>
                            </div>
                        `;
            }

            function showSkeletonLoading() {
                // Skeleton screen for better perceived performance
                var skeleton = '<div style="animation: fadeIn 0.3s ease-in;">';
                for (var i = 0; i < 5; i++) {
                    skeleton += '<div style="padding: 16px; margin-bottom: 12px; background: #f6f6f7; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">';
                    skeleton += '<div style="flex: 1;"><div style="height: 16px; background: #e1e3e5; border-radius: 4px; width: 60%; margin-bottom: 8px; animation: pulse 1.5s ease-in-out infinite;"></div>';
                    skeleton += '<div style="height: 12px; background: #e1e3e5; border-radius: 4px; width: 40%; animation: pulse 1.5s ease-in-out infinite;"></div></div>';
                    skeleton += '<div style="height: 20px; width: 60px; background: #e1e3e5; border-radius: 4px; animation: pulse 1.5s ease-in-out infinite;"></div>';
                    skeleton += '</div>';
                }
                skeleton += '</div>';
                skeleton += '<style>@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }</style>';
                document.getElementById('output').innerHTML = skeleton;
            }

            // CRITICAL: Helper to wait for App Bridge initialization
            window.waitForAppBridge = function () {
                return new Promise(function (resolve, reject) {
                    if (window.appBridgeReady && window.shopifyApp) {
                        resolve({ ready: true, app: window.shopifyApp });
                        return;
                    }
                    var attempts = 0;
                    var maxAttempts = 50; // Wait up to 5 seconds
                    var interval = setInterval(function () {
                        attempts++;
                        if (window.appBridgeReady && window.shopifyApp) {
                            clearInterval(interval);
                            resolve({ ready: true, app: window.shopifyApp });
                        } else if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            // Don't reject, just resolve with false to allow fallback logic to proceed
                            resolve({ ready: false });
                        }
                    }, 100);
                });
            };

            function setButtonLoading(button, isLoading) {
                if (isLoading) {
                    button.disabled = true;
                    button.style.opacity = '0.7';
                    button.style.cursor = 'wait';
                    const originalText = button.innerHTML;
                    button.dataset.originalText = originalText;
                    button.innerHTML = '<span style="display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 8px;"></span>Loading...';
                } else {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    if (button.dataset.originalText) {
                        button.innerHTML = button.dataset.originalText;
                        delete button.dataset.originalText;
                    }
                }
            }

            function processOrders(button) {
                // Debug logging removed for performance - only log errors if needed
                // Prevent rapid clicks (debounce)
                if (debounceTimers.processOrders) {
                    return; // Already processing
                }

                // Cancel previous request if exists
                cancelPreviousRequest('processOrders');

                // Check network status
                if (!isOnline) {
                    document.getElementById('output').innerHTML = `
                                <div style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">
                                    <div style="font-size: 15px; font-weight: 600; color: #202223; margin-bottom: 8px;">No Internet Connection</div>
                                    <div style="font-size: 14px; color: #6d7175; margin-bottom: 16px; line-height: 1.5;">Please check your internet connection and try again.</div>
                                    <button onclick="processOrders(this)" style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Try Again</button>
                                </div>
                            `;
                    return;
                }

                setButtonLoading(button, true);
                showSkeletonLoading(); // Show skeleton immediately for better UX
                setTimeout(function () {
                    showLoading('Loading orders...');
                }, 100);

                // Create AbortController for request cancellation
                var controller = new AbortController();
                activeRequests.processOrders = controller;

                // Get session token if in embedded mode - seamless integration
                var fetchPromise;
                var isEmbedded = window.isEmbedded || (window.location.search.indexOf('embedded=1') > -1) || (window.self !== window.top);

                // PERFECTED: Wait for App Bridge (uses Promise if available, sync check as fallback)
                if (isEmbedded) {
                    // Try Promise-based wait first
                    if (window.waitForAppBridge && typeof window.waitForAppBridge === 'function' && !window.appBridgeReady) {
                        // Wait for Promise to resolve
                        window.waitForAppBridge().then(function (bridgeState) {
                            if (bridgeState && bridgeState.ready && bridgeState.app) {
                                window.shopifyApp = bridgeState.app;
                                window.appBridgeReady = true;
                            }
                            // Always proceed with API call - will use session token if available, cookie auth as fallback
                            proceedWithApiCall();
                        }).catch(function (error) {
                            console.warn('App Bridge not available, using cookie auth fallback:', error.message);
                            // Fall back to cookie auth instead of showing error
                            proceedWithApiCall();
                        });
                        return;
                    }
                }
                // App Bridge ready or not embedded - proceed with API call
                proceedWithApiCall(); // Close if (isEmbedded)

                // Extract API call logic into function (called when Promise resolves or App Bridge ready)
                function proceedWithApiCall() {
                    // Debug logging removed for performance
                    if (isEmbedded && window.shopifyApp && window.appBridgeReady) {
                        // In embedded mode, we MUST have session token - retry up to 3 times
                        var retryCount = 0;
                        var maxRetries = 2; // Optimized: reduced from 3

                        function getTokenWithRetry() {
                            // Debug logging removed for performance
                            return window.shopifyApp.getSessionToken().then(function (token) {
                                if (!token && retryCount < maxRetries) {
                                    retryCount++;
                                    return new Promise(function (resolve, reject) {
                                        setTimeout(function () { getTokenWithRetry().then(resolve).catch(reject); }, 100); // Optimized: reduced from 300ms
                                    });
                                }
                                return token;
                            }).catch(function (err) {
                                // Debug logging removed for performance - only log if max retries exceeded
                                // If error and haven't exceeded retries, retry
                                if (retryCount < maxRetries) {
                                    retryCount++;
                                    return new Promise(function (resolve, reject) {
                                        setTimeout(function () { getTokenWithRetry().then(resolve).catch(reject); }, 100); // Optimized: reduced from 300ms
                                    });
                                }
                                // Max retries exceeded, throw error
                                throw err;
                            });
                        }

                        // Build API URL with shop param
                        var apiUrl = '/api/process_orders';
                        if (window.SHOP_PARAM) {
                            apiUrl += '?shop=' + encodeURIComponent(window.SHOP_PARAM);
                        }
                        if (isEmbedded) {
                            apiUrl = APP_URL + apiUrl;
                        }

                        // Use id_token from URL if available, otherwise try App Bridge
                        if (window.ID_TOKEN) {
                            fetchPromise = fetch(apiUrl, {
                                headers: { 'Authorization': 'Bearer ' + window.ID_TOKEN },
                                signal: controller.signal,
                                credentials: 'include'
                            });
                        } else {
                            fetchPromise = getTokenWithRetry().then(function (token) {
                                var headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                                return fetch(apiUrl, {
                                    headers: headers,
                                    signal: controller.signal,
                                    credentials: 'include'
                                });
                            }).catch(function (err) {
                                if (err.name === 'AbortError') return;
                                // Fall back to cookie auth with shop param
                                return fetch(apiUrl, {
                                    signal: controller.signal,
                                    credentials: 'include'
                                });
                            });
                        }
                    } else {
                        // Not embedded - use regular fetch with shop param if available
                        var apiUrl = '/api/process_orders';
                        if (window.SHOP_PARAM) {
                            apiUrl += '?shop=' + encodeURIComponent(window.SHOP_PARAM);
                        }
                        fetchPromise = fetch(apiUrl, {
                            signal: controller.signal,
                            credentials: 'include'
                        });
                    }

                    // Execute the Promise chain
                    fetchPromise
                        .then(r => {
                            // Debug logging removed for performance
                            // Check if request was cancelled
                            if (controller.signal.aborted) {
                                return null;
                            }
                            // Enhanced API response verification per external feedback
                            console.log('üì° API Response received:', {
                                status: r.status,
                                statusText: r.statusText,
                                url: r.url,
                                ok: r.ok,
                                contentType: r.headers.get('content-type')
                            });

                            if (!r.ok) {
                                // Enhanced error logging per external feedback
                                console.error('‚ùå API request failed:', {
                                    status: r.status,
                                    statusText: r.statusText,
                                    url: r.url,
                                    ok: r.ok
                                });
                                if (r.status === 404) {
                                    console.error('‚ùå 404 Not Found - Endpoint does not exist:', r.url);
                                    console.error('This may indicate a missing API route or incorrect URL');
                                } else if (r.status === 500) {
                                    console.error('‚ùå 500 Internal Server Error - Server-side error occurred');
                                    console.error('Check server logs for detailed error information');
                                }
                                // Try to parse JSON, but handle non-JSON responses
                                return r.text().then(function (text) {
                                    var err = {};
                                    try {
                                        err = JSON.parse(text);
                                    } catch (e) {
                                        // Not JSON - use text as error message
                                        err = { error: text || 'Unknown error', message: text || 'Unknown error' };
                                    }
                                    // Extract error from multiple possible fields
                                    var errorMsg = err.error || err.message || err.detail || err.description || (typeof err === 'string' ? err : 'API error unknown');
                                    throw new Error(errorMsg);
                                });
                            }
                            return r.json();
                        })
                        .then(d => {
                            // Check if request was cancelled
                            if (!d) return;

                            setButtonLoading(button, false);
                            activeRequests.processOrders = null;
                            if (debounceTimers.processOrders) {
                                clearTimeout(debounceTimers.processOrders);
                                debounceTimers.processOrders = null;
                            }

                            if (d.success) {
                                const icon = '‚úÖ';
                                document.getElementById('output').innerHTML = `
                                        <div style="animation: fadeIn 0.3s ease-in;">
                                            <h3 class="success" style="display: flex; align-items: center; gap: 8px;">
                                                <span>${icon}</span>
                                            </h3>
                                            <div style="margin-top: 12px; line-height: 1.6; color: #374151;">${d.html || d.message || d.error || 'No details available'}</div>
                                        </div>
                                    `;
                            } else {
                                // Professional error display with actionable buttons
                                var errorHtml = '<div style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">';
                                errorHtml += '<div style="font-size: 15px; font-weight: 600; color: #202223; margin-bottom: 8px;">' + (d.error || 'Something went wrong') + '</div>';
                                if (d.message) {
                                    errorHtml += '<div style="font-size: 14px; color: #6d7175; margin-bottom: 16px; line-height: 1.5;">' + d.message + '</div>';
                                }
                                if (d.action === 'refresh') {
                                    errorHtml += '<button onclick="window.location.reload()" style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Refresh Page</button>';
                                } else if (d.action === 'subscribe' && d.subscribe_url) {
                                    errorHtml += '<a href="' + d.subscribe_url + '" style="display: inline-block; padding: 8px 16px; background: #008060; color: #fff; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none;">Subscribe Now</a>';
                                } else if (d.action === 'install') {
                                    errorHtml += '<a href="/settings/shopify" style="display: inline-block; padding: 8px 16px; background: #008060; color: #fff; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none;">Connect Store</a>';
                                } else if (d.action === 'retry') {
                                    errorHtml += '<button onclick="processOrders(this)" style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Try Again</button>';
                                }
                                errorHtml += '</div>';
                                document.getElementById('output').innerHTML = errorHtml;
                            }
                        })
                        .catch(err => {
                            // Enhanced error handling per external feedback - prevent application freezing
                            console.error('‚ùå Failed to process orders:', err);
                            console.error('Error details:', {
                                message: err.message,
                                name: err.name,
                                stack: err.stack ? err.stack.substring(0, 300) : 'no stack'
                            });


                            // Always re-enable button and clear timers to prevent freezing
                            setButtonLoading(button, false);
                            activeRequests.processOrders = null;
                            if (debounceTimers.processOrders) {
                                clearTimeout(debounceTimers.processOrders);
                                debounceTimers.processOrders = null;
                            }
                            console.error('‚ùå API request error:', err);
                            var errorDetails = '';
                            if (err.message) {
                                errorDetails = '<div style="font-size: 12px; color: #8c9196; margin-top: 8px; padding: 8px; background: #f6f6f7; border-radius: 4px;">' + err.message + '</div>';
                            }
                            document.getElementById('output').innerHTML = `
                                    <div style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fff4f4; border: 1px solid #fecaca; border-radius: 8px;">
                                        <h3 class="error" style="color: #d72c0d; margin-bottom: 12px;">‚ùå Connection Error</h3>
                                        <p style="margin-top: 12px; color: #6d7175;">Unable to connect to server. Please check your internet connection and try again.</p>
                                        ${errorDetails}
                                        <p style="margin-top: 12px; font-size: 13px; color: #737373;">üí° Tip: If this persists, go to Settings and verify your Shopify store is connected.</p>
                                        <button onclick="processOrders(this)" style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; margin-top: 12px;">Try Again</button>
                                    </div>
                                `;
                        });
                } // Close proceedWithApiCall function
            } // Close processOrders function
            window.processOrders = processOrders; // Ensure global availability immediately

            // Ensure function is in global scope
            window.processOrders = processOrders;

            function updateInventory(button) {
                // Debug logging removed for performance - only log errors if needed
                // Prevent rapid clicks (debounce)
                if (debounceTimers.updateInventory) {
                    return; // Already processing
                }

                // Cancel previous request if exists
                cancelPreviousRequest('updateInventory');

                // Check network status
                if (!isOnline) {
                    document.getElementById('output').innerHTML = `
                                <div style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">
                                    <div style="font-size: 15px; font-weight: 600; color: #202223; margin-bottom: 8px;">No Internet Connection</div>
                                    <div style="font-size: 14px; color: #6d7175; margin-bottom: 16px; line-height: 1.5;">Please check your internet connection and try again.</div>
                                    <button onclick="updateInventory(this)" style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Try Again</button>
                                </div>
                            `;
                    return;
                }

                setButtonLoading(button, true);
                showSkeletonLoading(); // Show skeleton immediately for better UX
                setTimeout(function () {
                    showLoading('Loading inventory...');
                }, 100);

                // Create AbortController for request cancellation
                var controller = new AbortController();
                activeRequests.updateInventory = controller;

                // Get session token if in embedded mode - seamless integration
                var fetchPromise;
                var isEmbedded = window.isEmbedded; // Use global flag

                // Wait for App Bridge if available, but fall back to cookie auth if not
                if (isEmbedded && window.waitForAppBridge && typeof window.waitForAppBridge === 'function' && !window.appBridgeReady) {
                    window.waitForAppBridge().then(function (bridgeState) {
                        if (bridgeState && bridgeState.ready && bridgeState.app) {
                            window.shopifyApp = bridgeState.app;
                            window.appBridgeReady = true;
                        }
                        proceedWithApiCall();
                    }).catch(function (error) {
                        console.warn('App Bridge not available, using cookie auth fallback:', error.message);
                        proceedWithApiCall();
                    });
                    return;
                }
                proceedWithApiCall();

                // Extract API call logic into function
                function proceedWithApiCall() {
                    // Build API URL with shop param
                    var apiUrl = '/api/update_inventory';
                    if (window.SHOP_PARAM) {
                        apiUrl += '?shop=' + encodeURIComponent(window.SHOP_PARAM);
                    }
                    if (isEmbedded) {
                        apiUrl = APP_URL + apiUrl;
                    }

                    // Use id_token from URL if available
                    if (window.ID_TOKEN) {
                        fetchPromise = fetch(apiUrl, {
                            headers: { 'Authorization': 'Bearer ' + window.ID_TOKEN },
                            signal: controller.signal,
                            credentials: 'include'
                        });
                    } else if (isEmbedded && window.shopifyApp && window.appBridgeReady) {
                        // Try App Bridge token
                        var retryCount = 0;
                        var maxRetries = 2;

                        function getTokenWithRetry() {
                            return window.shopifyApp.getSessionToken().then(function (token) {
                                if (!token && retryCount < maxRetries) {
                                    retryCount++;
                                    return new Promise(function (resolve, reject) {
                                        setTimeout(function () { getTokenWithRetry().then(resolve).catch(reject); }, 100);
                                    });
                                }
                                return token;
                            }).catch(function (err) {
                                if (retryCount < maxRetries) {
                                    retryCount++;
                                    return new Promise(function (resolve, reject) {
                                        setTimeout(function () { getTokenWithRetry().then(resolve).catch(reject); }, 100);
                                    });
                                }
                                throw err;
                            });
                        }

                        fetchPromise = getTokenWithRetry().then(function (token) {
                            var headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                            return fetch(apiUrl, {
                                headers: headers,
                                signal: controller.signal,
                                credentials: 'include'
                            });
                        }).catch(function (err) {
                            if (err.name === 'AbortError') return;
                            return fetch(apiUrl, {
                                signal: controller.signal,
                                credentials: 'include'
                            });
                        });
                    } else {
                        // No token - try with shop param only
                        fetchPromise = fetch(apiUrl, {
                            signal: controller.signal,
                            credentials: 'include'
                        });
                    }

                    // Execute the Promise chain inside proceedWithApiCall so it runs in all code paths
                    fetchPromise
                        .then(r => {
                            // Check if request was cancelled
                            if (controller.signal.aborted) {
                                return null;
                            }
                            if (!r.ok) {
                                return r.text().then(text => {
                                    try {
                                        var json = JSON.parse(text);
                                        var errorMsg = json.error || json.message || json.detail || json.description || 'Request failed';
                                        throw new Error(errorMsg);
                                    } catch (e) {
                                        if (e.message && e.message !== 'Request failed') throw e;
                                        throw new Error(text || 'Network error');
                                    }
                                });
                            }
                            return r.json();
                        })
                        .then(d => {
                            // Check if request was cancelled
                            if (!d) return;

                            setButtonLoading(button, false);
                            activeRequests.updateInventory = null;
                            if (debounceTimers.updateInventory) {
                                clearTimeout(debounceTimers.updateInventory);
                                debounceTimers.updateInventory = null;
                            }

                            if (d.success) {
                                const icon = '‚úÖ';
                                document.getElementById('output').innerHTML = `
                                        <div style="animation: fadeIn 0.3s ease-in;">
                                            <h3 class="success" style="display: flex; align-items: center; gap: 8px;">
                                                <span>${icon}</span>
                                                <span>Inventory Updated</span>
                                            </h3>
                                            <div style="margin-top: 12px; white-space: pre-wrap; line-height: 1.6;">${d.html || d.message || d.error || 'No details available'}</div>
                                            <script>
                                                // Trigger stock bar animations after content is injected
                                                setTimeout(function() {
                                                    var bars = document.querySelectorAll('.stock-bar-fill');
                                                    bars.forEach(function(bar) {
                                                        var targetWidth = bar.getAttribute('data-target-width');
                                                        if (targetWidth) {
                                                            bar.style.width = targetWidth;
                                                        }
                                                    });
                                                }, 50);
        </script>
    </div>
    `;
    } else {
    // Professional error display with actionable buttons
    var errorHtml = '<div
        style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">
        ';
        errorHtml += '<div style="font-size: 15px; font-weight: 600; color: #202223; margin-bottom: 8px;">' + (d.error
            || 'Something went wrong') + '</div>';
        if (d.message) {
        errorHtml += '<div style="font-size: 14px; color: #6d7175; margin-bottom: 16px; line-height: 1.5;">' + d.message
            + '</div>';
        }
        if (d.action === 'refresh') {
        errorHtml += '<button onclick="window.location.reload()"
            style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Refresh
            Page</button>';
        } else if (d.action === 'subscribe' && d.subscribe_url) {
        errorHtml += '<a href="' + d.subscribe_url + '"
            style="display: inline-block; padding: 8px 16px; background: #008060; color: #fff; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none;">Subscribe
            Now</a>';
        } else if (d.action === 'install') {
        errorHtml += '<a href="/settings/shopify"
            style="display: inline-block; padding: 8px 16px; background: #008060; color: #fff; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none;">Connect
            Store</a>';
        } else if (d.action === 'retry') {
        errorHtml += '<button onclick="updateInventory(this)"
            style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Try
            Again</button>';
        } else {
        // Fallback: try to display HTML error if it's HTML
        if (d.error && d.error.includes('<')) { errorHtml='<div style="animation: fadeIn 0.3s ease-in;">' + d.error
            + '</div>' ; } } if (!errorHtml.includes('</div>')) errorHtml += '</div>';
    document.getElementById('output').innerHTML = errorHtml;
    }
    })
    .catch(err => {
    // Don't show error if request was cancelled
    if (err.name === 'AbortError') {
    return;
    }

    setButtonLoading(button, false);
    activeRequests.updateInventory = null;
    if (debounceTimers.updateInventory) {
    clearTimeout(debounceTimers.updateInventory);
    debounceTimers.updateInventory = null;
    }

    var errorMessage = 'Unable to connect to server. Please check your internet connection and try again.';
    if (!isOnline) {
    errorMessage = 'No internet connection. Please check your network and try again.';
    }

    document.getElementById('output').innerHTML = `
    <div
        style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">
        <div style="font-size: 15px; font-weight: 600; color: #202223; margin-bottom: 8px;">Connection Error</div>
        <div style="font-size: 14px; color: #6d7175; margin-bottom: 16px; line-height: 1.5;">${errorMessage}</div>
        <button onclick="updateInventory(this)"
            style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; margin-right: 8px;">Try
            Again</button>
        <a href="/settings/shopify"
            style="display: inline-block; padding: 8px 16px; background: #f6f6f7; color: #202223; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none;">Check
            Settings</a>
    </div>
    `;
    });
    } // Close proceedWithApiCall function
    }
    window.updateInventory = updateInventory; // Ensure global availability immediately

    // Ensure function is in global scope
    window.updateInventory = updateInventory;

    function generateReport(button) {
    // Debug logging removed for performance - only log errors if needed
    // Prevent rapid clicks (debounce)
    if (debounceTimers.generateReport) {
    return; // Already processing
    }

    // Cancel previous request if exists
    cancelPreviousRequest('generateReport');

    // Check network status
    if (!isOnline) {
    document.getElementById('output').innerHTML = `
    <div
        style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">
        <div style="font-size: 15px; font-weight: 600; color: #202223; margin-bottom: 8px;">No Internet Connection</div>
        <div style="font-size: 14px; color: #6d7175; margin-bottom: 16px; line-height: 1.5;">Please check your internet
            connection and try again.</div>
        <button onclick="generateReport(this)"
            style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Try
            Again</button>
    </div>
    `;
    return;
    }

    setButtonLoading(button, true);
    showSkeletonLoading(); // Show skeleton immediately for better UX
    setTimeout(function () {
    showLoading('Generating report...');
    }, 100);

    // Create AbortController for request cancellation
    var controller = new AbortController();
    activeRequests.generateReport = controller;

    // Get session token if in embedded mode - seamless integration
    var fetchPromise;
    var isEmbedded = window.isEmbedded; // Use global flag

    // Wait for App Bridge if available, but fall back to cookie auth if not
    if (isEmbedded && window.waitForAppBridge && typeof window.waitForAppBridge === 'function' &&
    !window.appBridgeReady) {
    window.waitForAppBridge().then(function (bridgeState) {
    if (bridgeState && bridgeState.ready && bridgeState.app) {
    window.shopifyApp = bridgeState.app;
    window.appBridgeReady = true;
    }
    proceedWithApiCall();
    }).catch(function (error) {
    console.warn('App Bridge not available, using cookie auth fallback:', error.message);
    proceedWithApiCall();
    });
    return;
    }
    proceedWithApiCall();

    // Extract API call logic into function
    function proceedWithApiCall() {
    // Build report URL with shop param
    var reportUrl = '/api/generate_report';
    if (window.SHOP_PARAM) {
    reportUrl += '?shop=' + encodeURIComponent(window.SHOP_PARAM);
    }
    if (isEmbedded) {
    reportUrl = APP_URL + reportUrl;
    }

    // Use id_token from URL if available
    if (window.ID_TOKEN) {
    fetchPromise = fetch(reportUrl, {
    headers: { 'Authorization': 'Bearer ' + window.ID_TOKEN },
    signal: controller.signal,
    credentials: 'include'
    });
    } else if (isEmbedded && window.shopifyApp && window.appBridgeReady) {
    // Try App Bridge token
    fetchPromise = window.shopifyApp.getSessionToken().then(function (token) {
    var headers = token ? { 'Authorization': 'Bearer ' + token } : {};
    return fetch(reportUrl, {
    headers: headers,
    signal: controller.signal,
    credentials: 'include'
    });
    }).catch(function (err) {
    if (err.name === 'AbortError') return;
    return fetch(reportUrl, {
    signal: controller.signal,
    credentials: 'include'
    });
    });
    } else {
    // No token - use shop param in URL
    fetchPromise = fetch(reportUrl, {
    signal: controller.signal,
    credentials: 'include'
    });
    }

    // Execute the Promise chain inside proceedWithApiCall so it runs in all code paths
    fetchPromise
    .then(r => r.json())
    .then(d => {
    // Check if request was cancelled
    if (!d) return;

    setButtonLoading(button, false);
    activeRequests.generateReport = null;
    if (debounceTimers.generateReport) {
    clearTimeout(debounceTimers.generateReport);
    debounceTimers.generateReport = null;
    }

    // Check if the response contains an error message (from backend)
    if (d.success) {
    const html = d.html || d.message || "Report generated successfully";
    document.getElementById('output').innerHTML = `
    <div style="animation: fadeIn 0.3s ease-in;">
        <h3 class="success" style="display: flex; align-items: center; gap: 8px;">
            <span>‚úÖ</span>
            <span>Revenue Report Generated</span>
        </h3>
        <div style="margin-top: 12px; line-height: 1.6;">${html}</div>
    </div>
    `;
    } else {
    // Handle error case
    const error_message = d.error || "Failed to generate report";
    if (error_message.includes('Error Loading revenue') || error_message.includes('No Shopify store connected')) {
    // Backend already formatted the error, display directly
    document.getElementById('output').innerHTML = `<div style="animation: fadeIn 0.3s ease-in;">${error_message}</div>`;
    } else {
    // Show generic error
    document.getElementById('output').innerHTML = `<div style="animation: fadeIn 0.3s ease-in; color: #dc2626;">
        ${error_message}</div>`;
    }
    }
    })
    .catch(err => {
    // Don't show error if request was cancelled
    if (err.name === 'AbortError') {
    return;
    }

    setButtonLoading(button, false);
    activeRequests.generateReport = null;
    if (debounceTimers.generateReport) {
    clearTimeout(debounceTimers.generateReport);
    debounceTimers.generateReport = null;
    }

    // Try to parse JSON error message if it looks like one
    let errorDisplayMessage = err.message;
    let isJsonError = false;
    try {
    const jsonError = JSON.parse(err.message);
    if (jsonError.error) {
    errorDisplayMessage = jsonError.error;
    isJsonError = true;
    }
    } catch (e) {
    // Not JSON
    }

    // Check if error message is HTML (from backend)
    if (err.message && (err.message.includes('Error Loading revenue') || err.message.includes('<div'))) { // Backend
        error HTML - display as is document.getElementById('output').innerHTML=`<div
        style="animation: fadeIn 0.3s ease-in;">${err.message}</div>`;
        } else if (isJsonError || (errorDisplayMessage && errorDisplayMessage.length < 200 &&
            !errorDisplayMessage.includes('Unable to generate'))) { // JSON error or short text error (likely from
            backend middleware) document.getElementById('output').innerHTML=` <div
            style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">
            <div style="font-size: 15px; font-weight: 600; color: #b45309; margin-bottom: 8px;">Request Failed</div>
            <div style="font-size: 14px; color: #92400e; margin-bottom: 16px; line-height: 1.5;">${errorDisplayMessage}
            </div>
            <button onclick="generateReport(this)"
                style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer;">Try
                Again</button>
            </div>
            `;
            } else {
            // Network error or unknown long error
            var errorMessage = 'Unable to generate report. Please check your internet connection and try again.';
            if (!isOnline) {
            errorMessage = 'No internet connection. Please check your network and try again.';
            }

            document.getElementById('output').innerHTML = `
            <div
                style="animation: fadeIn 0.3s ease-in; padding: 20px; background: #fffbf0; border: 1px solid #fef3c7; border-radius: 8px;">
                <div style="font-size: 15px; font-weight: 600; color: #202223; margin-bottom: 8px;">Connection Error
                </div>
                <div style="font-size: 14px; color: #6d7175; margin-bottom: 16px; line-height: 1.5;">${errorMessage}
                </div>
                <div style="font-size: 12px; color: #9ca3af; margin-bottom: 12px; font-family: monospace;">Details:
                    ${err.message.substring(0, 100)}</div>
                <button onclick="generateReport(this)"
                    style="padding: 8px 16px; background: #008060; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; margin-right: 8px;">Try
                    Again</button>
                <a href="/settings/shopify"
                    style="display: inline-block; padding: 8px 16px; background: #f6f6f7; color: #202223; border-radius: 6px; font-size: 14px; font-weight: 500; text-decoration: none;">Check
                    Settings</a>
            </div>
            `;
            }
            });
            } // end proceedWithApiCall
            }
            window.generateReport = generateReport; // Ensure global availability immediately

            // Ensure function is in global scope
            window.generateReport = generateReport;

            // ============================================================================
            // FUNCTION AVAILABILITY VERIFICATION (Per External Feedback)
            // ============================================================================
            // Log function availability immediately after all assignments
            console.log('Function check:', {
            processOrders: typeof window.processOrders,
            updateInventory: typeof window.updateInventory,
            generateReport: typeof window.generateReport
            });

            // Immediate function check after all assignments
            console.log('‚úÖ Function check (after all assignments):', {
            processOrders: typeof window.processOrders,
            updateInventory: typeof window.updateInventory,
            generateReport: typeof window.generateReport
            });

            // Verify all functions are properly assigned
            if (typeof window.processOrders !== 'function' ||
            typeof window.updateInventory !== 'function' ||
            typeof window.generateReport !== 'function') {
            console.error('‚ùå CRITICAL: Functions not properly assigned to window!');
            console.error('Missing functions:', {
            processOrders: typeof window.processOrders !== 'function',
            updateInventory: typeof window.updateInventory !== 'function',
            generateReport: typeof window.generateReport !== 'function'
            });
            } else {
            console.log('‚úÖ All functions successfully assigned to window object');
            }



            // ============================================================================
            // NETWORK REQUEST LOGGING - Capture all API requests (OPTIMIZED)
            // ============================================================================
            // Intercept fetch requests to log network activity
            // CRITICAL: Skip debug endpoint to prevent infinite loops and performance issues
            (function () {
            var originalFetch = window.fetch;
            window.fetch = function () {
            var args = Array.prototype.slice.call(arguments);
            var url = args[0];
            var options = args[1] || {};
            var method = options.method || 'GET';

            var startTime = Date.now();

            // Only log API requests, not all requests (reduces noise)
            if (typeof url === 'string' && (url.includes('/api/') || url.startsWith('http'))) {
            console.log('üåê Network Request:', {
            url: url,
            method: method,
            timestamp: new Date().toISOString()
            });
            }

            // Call original fetch
            return originalFetch.apply(this, args)
            .then(function (response) {
            var endTime = Date.now();
            var duration = endTime - startTime;

            // Only log API responses, and only if there's an error or slow response
            if (typeof url === 'string' && (url.includes('/api/') || url.startsWith('http'))) {
            if (!response.ok || duration > 1000) {
            console.log('üåê Network Response:', {
            url: url,
            method: method,
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            duration: duration + 'ms',
            timestamp: new Date().toISOString()
            });
            }
            }

            return response;
            })
            .catch(function (error) {
            var endTime = Date.now();
            var duration = endTime - startTime;

            // Only log errors for API requests
            if (typeof url === 'string' && (url.includes('/api/') || url.startsWith('http'))) {
            console.error('üåê Network Error:', {
            url: url,
            method: method,
            error: error.message || 'Unknown error',
            errorName: error.name || 'Unknown',
            duration: duration + 'ms',
            timestamp: new Date().toISOString()
            });
            }

            throw error;
            });
            };
            })();

            // ============================================================================
            // ROBUST BUTTON EVENT HANDLING - Event Delegation Pattern (Most Reliable)
            // ============================================================================
            // Use event delegation - attach ONE listener to document that handles ALL button clicks
            // This works even if buttons are added dynamically or listeners fail to attach
            // FIXED: Always wait for DOMContentLoaded to ensure DOM and dependencies are ready
            // FIXED: Verify functions exist before setting up listener (per external feedback)
            document.addEventListener('DOMContentLoaded', function setupEventDelegation() {
            console.log('‚úÖ DOMContentLoaded fired');

            // Verify functions are assigned to window before setting up listener
            var functionsReady = typeof window.processOrders === 'function' &&
            typeof window.updateInventory === 'function' &&
            typeof window.generateReport === 'function';

            if (!functionsReady) {
            console.error('‚ùå Functions not ready yet. Retrying in 100ms...');
            console.log('Function status:', {
            processOrders: typeof window.processOrders,
            updateInventory: typeof window.updateInventory,
            generateReport: typeof window.generateReport
            });
            // Retry after short delay
            setTimeout(setupEventDelegation, 100);
            return;
            }

            console.log('‚úÖ All functions ready:', {
            processOrders: typeof window.processOrders,
            updateInventory: typeof window.updateInventory,
            generateReport: typeof window.generateReport
            });

            var buttonsFound = document.querySelectorAll('.card-btn[data-action]').length;
            console.log('‚úÖ Buttons found:', buttonsFound);


            // CRITICAL: Add EARLY click listener to catch ALL clicks before anything else
            // OPTIMIZED: Only log button clicks to reduce performance impact
            document.addEventListener('click', function (e) {
            // Only log if it's actually a button click (reduces noise)
            var closestBtn = e.target.closest('.card-btn[data-action]');
            if (!closestBtn) return; // Skip non-button clicks

            }, true); // Capture phase - fires FIRST

            // Attach click listener to document for event delegation (per external feedback)
            document.addEventListener('click', function (e) {
            // Find the closest button with data-action attribute
            var btn = e.target.closest('.card-btn[data-action]');
            if (!btn) {
            return; // Exit if clicked element is not a button (no logging to reduce noise)
            }

            // ENHANCED LOGGING: Capture state before action (OPTIMIZED - minimal logging)
            var action = btn.getAttribute('data-action');
            console.log('‚úÖ Button clicked:', action);

            // Check CSS/pointer-events issues (only log if there's a problem)
            var computedStyle = window.getComputedStyle(btn);
            var pointerEvents = computedStyle.pointerEvents;
            var display = computedStyle.display;
            var visibility = computedStyle.visibility;

            if (pointerEvents === 'none' || display === 'none' || visibility === 'hidden') {
            console.warn('‚ö†Ô∏è Button CSS issue:', {
            pointerEvents: pointerEvents,
            display: display,
            visibility: visibility
            });
            }


            e.preventDefault(); // Prevent any default behavior
            e.stopPropagation();

            if (!action) {
            console.warn('‚ö†Ô∏è Button has no data-action attribute');
            return; // No action specified
            }

            // Check if button is disabled
            if (btn.disabled) {
            console.warn('‚ö†Ô∏è Button is disabled, ignoring click');
            return;
            }

            // Route to appropriate function based on data-action (per external feedback)
            // Enhanced error handling to prevent application freezing
            if (window[action] && typeof window[action] === 'function') {
            try {
            console.log('‚úÖ Calling function:', action);
            window[action](btn); // Call the corresponding function
            } catch (err) {
            // Catch synchronous errors to prevent freezing
            console.error('‚ùå Error executing function:', action, err);
            console.error('Error details:', {
            message: err.message,
            name: err.name,
            stack: err.stack ? err.stack.substring(0, 300) : 'no stack',
            buttonState: {
            disabled: btn.disabled,
            innerHTML: btn.innerHTML.substring(0, 50)
            }
            });
            // Show user-friendly error message
            var outputEl = document.getElementById('output');
            if (outputEl) {
            outputEl.innerHTML = '<div
                style="padding: 20px; background: #fff4f4; border: 1px solid #fecaca; border-radius: 8px;">
                <div style="font-size: 15px; font-weight: 600; color: #d72c0d; margin-bottom: 8px;">‚ùå Error</div>
                <div style="font-size: 14px; color: #6d7175;">An error occurred: ' + (err.message || 'Unknown error') +
                    '</div>
            </div>';
            }
            // Re-enable button
            btn.disabled = false;
            if (btn.dataset.originalText) {
            btn.innerHTML = btn.dataset.originalText;
            }
            }
            } else {
            console.error('‚ùå Function not found for action:', action); // Log error for missing function (per external
            feedback)
            console.error('Available functions:', {
            processOrders: typeof window.processOrders,
            updateInventory: typeof window.updateInventory,
            generateReport: typeof window.generateReport,
            requestedAction: typeof window[action]
            });
            }
            }, true); // Use capture phase to catch early

            console.log('‚úÖ Event delegation listener attached successfully');

            // CRITICAL: Add direct button test listeners as backup
            // This will help us verify if buttons are clickable at all
            var testButtons = document.querySelectorAll('.card-btn[data-action]');
            console.log('üîç Found buttons for direct testing:', testButtons.length);
            testButtons.forEach(function (btn, index) {
            var action = btn.getAttribute('data-action');
            console.log('üîç Button ' + index + ':', {
            action: action,
            disabled: btn.disabled,
            className: btn.className
            });

            // Add direct click listener as backup test
            btn.addEventListener('click', function (e) {
            console.log('üîç DIRECT BUTTON LISTENER FIRED for:', action);
            console.log('üîç Direct listener details:', {
            action: action,
            disabled: btn.disabled,
            defaultPrevented: e.defaultPrevented,
            propagationStopped: false
            });
            }, true); // Capture phase
            });

            });
            // ============================================================================
            // END ROBUST BUTTON EVENT HANDLING
            // ============================================================================

            // Quick Menu Toggle
            function toggleQuickMenu(event) {
            event.stopPropagation();
            var menu = document.getElementById('quickMenu');
            if (menu) {
            menu.classList.toggle('show');
            }
            }
            // Close quick menu when clicking outside
            document.addEventListener('click', function (e) {
            var menu = document.getElementById('quickMenu');
            var btn = e.target.closest('.quick-menu-btn');
            if (menu && !btn && !e.target.closest('.quick-menu-dropdown')) {
            menu.classList.remove('show');
            }
            });

            // Keyboard shortcuts for power users
            document.addEventListener('keydown', function (e) {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            return;
            }

            // Ctrl/Cmd + 1 = Process Orders
            if ((e.ctrlKey || e.metaKey) && e.key === '1') {
            e.preventDefault();
            {% if has_access %}
            var btn = document.querySelector('.card-btn[data-action="processOrders"]');
            if (btn) processOrders(btn);
            {% else %}
            showSubscribePrompt();
            {% endif %}
            }
            // Ctrl/Cmd + 2 = Check Inventory
            if ((e.ctrlKey || e.metaKey) && e.key === '2') {
            e.preventDefault();
            {% if has_access %}
            var btn = document.querySelector('.card-btn[data-action="updateInventory"]');
            if (btn) updateInventory(btn);
            {% else %}
            showSubscribePrompt();
            {% endif %}
            }
            // Ctrl/Cmd + 3 = Generate Report
            if ((e.ctrlKey || e.metaKey) && e.key === '3') {
            e.preventDefault();
            {% if has_access %}
            var btn = document.querySelector('.card-btn[data-action="generateReport"]');
            if (btn) generateReport(btn);
            {% else %}
            showSubscribePrompt();
            {% endif %}
            }
            // Ctrl/Cmd + E = CSV Exports
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            window.location.href = '/features/csv-exports{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{%
            endif %}{% endif %}';
            }
            // Ctrl/Cmd + S = Scheduled Reports
            if ((e.ctrlKey || e.metaKey) && e.key === 's' && !e.shiftKey) {
            e.preventDefault();
            window.location.href = '/features/scheduled-reports{% if shop %}?shop={{ shop }}{% if host %}&host={{ host
            }}{% endif %}{% endif %}';
            }
            // Ctrl/Cmd + D = Comprehensive Dashboard
            if ((e.ctrlKey || e.metaKey) && e.key === 'd' && !e.shiftKey) {
            e.preventDefault();
            window.location.href = '/features/dashboard{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{%
            endif %}{% endif %}';
            }
            // Ctrl/Cmd + , = Settings
            if ((e.ctrlKey || e.metaKey) && e.key === ',') {
            e.preventDefault();
            window.location.href = '/settings/shopify{% if shop %}?shop={{ shop }}{% if host %}&host={{ host }}{% endif
            %}{% endif %}';
            }
            // Escape = Close quick menu
            if (e.key === 'Escape') {
            var menu = document.getElementById('quickMenu');
            if (menu) menu.classList.remove('show');
            }
            });

            // Track page views (if analytics is set up)
            if (typeof gtag !== 'undefined') {
            gtag('event', 'page_view', {
            'page_title': 'Dashboard',
            'page_location': window.location.href
            });
            }

            // CRITICAL: Preserve shop and host parameters when clicking links in embedded mode
            // This ensures navigation doesn't lose the embedded context
            (function () {
            if (window.isEmbedded) {
            var urlParams = new URLSearchParams(window.location.search);
            var shop = urlParams.get('shop');
            var host = urlParams.get('host');

            // Intercept all link clicks and preserve shop/host parameters
            document.addEventListener('click', function (e) {
            var target = e.target;
            // Find the closest anchor tag
            while (target && target.tagName !== 'A') {
            target = target.parentElement;
            }

            if (target && target.tagName === 'A' && target.href) {
            var href = target.href;
            // CRITICAL: For embedded mode, convert relative URLs to absolute URLs
            // This prevents Shopify from interpreting them as admin paths (404 errors)
            if (href.startsWith('/') && !href.startsWith('//')) {
            // Relative URL - convert to absolute using APP_URL or current origin
            var appUrl = '{{ APP_URL or "" }}' || window.location.origin;
            href = appUrl + href;
            target.href = href; // Update immediately
            }
            // Only process internal links (absolute URLs to our app)
            if (href.startsWith(window.location.origin) || (href.startsWith('https://') &&
            href.includes('employeesuite-production.onrender.com'))) {
            try {
            var url = new URL(href);
            // Preserve shop and host if they exist in current URL
            if (shop && !url.searchParams.has('shop')) {
            url.searchParams.set('shop', shop);
            }
            if (host && !url.searchParams.has('host')) {
            url.searchParams.set('host', host);
            }
            // Update the href with full absolute URL
            target.href = url.toString();
            } catch (err) {
            // If URL parsing fails, try simple string manipulation
            if (shop || host) {
            var separator = href.includes('?') ? '&' : '?';
            var params = [];
            if (shop && !href.includes('shop=')) {
            params.push('shop=' + encodeURIComponent(shop));
            }
            if (host && !href.includes('host=')) {
            params.push('host=' + encodeURIComponent(host));
            }
            if (params.length > 0) {
            target.href = href + separator + params.join('&');
            }
            }
            }
            }
            }
            }, true); // Use capture phase to catch all clicks
            }
            })();

            // Add this function to verify function availability
            function callFunctionSafely(functionName, button) {
            if (typeof window[functionName] === 'function') {
            try {
            window[functionName](button);
            } catch (error) {
            console.error('Function call failed:', functionName, error);
            showErrorMessage('An error occurred. Please refresh the page and try again.');
            }
            } else {
            console.error('Function not available:', functionName);
            showErrorMessage('Feature not available. Please refresh the page.');
            }
            }

            function showErrorMessage(message) {
            var outputEl = document.getElementById('output');
            if (outputEl) {
            outputEl.innerHTML = '<div
                style="padding: 20px; background: #fff4f4; border: 1px solid #fecaca; border-radius: 8px;">
                <div style="color: #d72c0d; font-weight: 600;">' + message + '</div>
            </div>';
            }
            }
            </script>

            <footer style="
                margin-top: 64px;
                padding: 32px 24px;
                border-top: 1px solid #e1e3e5;
                text-align: center;
                background: #ffffff;
            ">
                <div style="max-width: 1200px; margin: 0 auto">
                    <div style="
                        display: flex;
                        justify-content: center;
                        gap: 20px;
                        flex-wrap: wrap;
                        font-size: 14px;
                        margin-bottom: 16px;
                    ">
                        <a href="/faq" style="
                            color: #6d7175;
                            text-decoration: none;
                            font-weight: 400;
                            transition: color 0.15s;
                        ">FAQ</a>
                        <span style="color: #e1e3e5">|</span>
                        <a href="/privacy" style="
                            color: #6d7175;
                            text-decoration: none;
                            font-weight: 400;
                            transition: color 0.15s;
                        ">Privacy Policy</a>
                        <span style="color: #e1e3e5">|</span>
                        <a href="/terms" style="
                            color: #6d7175;
                            text-decoration: none;
                            font-weight: 400;
                            transition: color 0.15s;
                        ">Terms of Service</a>
                    </div>
                    <div style="color: #8c9196; font-size: 13px; font-weight: 400">
                        ¬© 2026 Employee Suite. All rights reserved.
                    </div>
                </div>
            </footer>
            <script>
            // Ensure any critical closing scripts are here
            </script>
            </div> <!-- End .container -->
            </div> <!-- End .page-wrapper -->
</body>

</html>