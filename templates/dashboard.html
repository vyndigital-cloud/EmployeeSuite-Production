{% extends "base.html" %}

{% block content %}
<div class="page-header flex-between">
    <div>
        <h1 class="page-title">Dashboard</h1>
        <div class="page-subtitle">Overview of your store performance</div>
    </div>

    {% if not has_access %}
    <a href="#" onclick="window.openPage('/subscribe'); return false;" class="btn-primary">
        <i class="ph-bold ph-lightning"></i>
        Upgrade to Pro
    </a>
    {% endif %}
</div>

<!-- Quick Stats / KPI Row -->
{% if has_shopify and quick_stats.has_data and is_subscribed %}
<div class="grid-cols-3" style="margin-bottom: 32px;">
    <!-- Pending Orders -->
    <div class="card-premium animate-enter delay-100">
        <div class="flex-between" style="margin-bottom: 16px;">
            <span class="text-slate-500 font-bold" style="font-size: 12px; text-transform: uppercase;">Pending
                Orders</span>
            <div style="background: var(--primary-light); color: var(--primary); padding: 8px; border-radius: 8px;">
                <i class="ph-fill ph-package" style="font-size: 20px;"></i>
            </div>
        </div>
        <div class="flex-between" style="align-items: baseline;">
            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">
                {{ quick_stats.pending_orders or 0 }}
            </div>
            <span class="status-badge warning">Action Needed</span>
        </div>
    </div>

    <!-- Total Products -->
    <div class="card-premium animate-enter delay-200">
        <div class="flex-between" style="margin-bottom: 16px;">
            <span class="text-slate-500 font-bold" style="font-size: 12px; text-transform: uppercase;">Total
                Products</span>
            <div style="background: var(--slate-100); color: var(--slate-600); padding: 8px; border-radius: 8px;">
                <i class="ph-fill ph-tag" style="font-size: 20px;"></i>
            </div>
        </div>
        <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">
            {{ quick_stats.total_products or 0 }}
        </div>
    </div>

    <!-- Low Stock -->
    <div class="card-premium animate-enter delay-300">
        <div class="flex-between" style="margin-bottom: 16px;">
            <span class="text-slate-500 font-bold" style="font-size: 12px; text-transform: uppercase;">Low Stock</span>
            <div
                style="background: {% if quick_stats.low_stock_items > 0 %}#fee2e2{% else %}#dcfce7{% endif %}; color: {% if quick_stats.low_stock_items > 0 %}#991b1b{% else %}#166534{% endif %}; padding: 8px; border-radius: 8px;">
                <i class="ph-fill ph-warning-circle" style="font-size: 20px;"></i>
            </div>
        </div>
        <div class="flex-between" style="align-items: baseline;">
            <div
                style="font-size: 32px; font-weight: 700; color: {% if quick_stats.low_stock_items > 0 %}#ef4444{% else %}var(--text-primary){% endif %};">
                {{ quick_stats.low_stock_items or 0 }}
            </div>
            {% if quick_stats.low_stock_items > 0 %}
            <span class="status-badge error">Restock</span>
            {% else %}
            <span class="status-badge success">Healthy</span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}


<!-- Feature Cards Grid -->
<div class="grid-cols-3">

    <!-- Order Processing -->
    <div class="card-premium">
        <div style="margin-bottom: 20px;">
            <div
                style="width: 48px; height: 48px; background: var(--slate-50); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; color: var(--primary);">
                <i class="ph-duotone ph-shopping-cart" style="font-size: 24px;"></i>
            </div>
            <h3 class="font-bold text-lg" style="margin-bottom: 8px;">Order Processing</h3>
            <p class="text-slate-500" style="font-size: 14px;">View latest pending orders and manage fulfillment status
                directly.</p>
        </div>

        <div id="orders-output"></div> <!-- Dynamic Content Target -->

        {% if has_access %}
        <button class="btn-secondary" style="width: 100%; justify-content: center;"
            onclick="handleAction('processOrders', this)">
            View Orders <i class="ph-bold ph-arrow-right"></i>
        </button>
        {% else %}
        <button class="btn-secondary" style="width: 100%; justify-content: center; opacity: 0.6;" disabled>
            <i class="ph-fill ph-lock-key"></i> Locked
        </button>
        {% endif %}
    </div>

    <!-- Inventory -->
    <div class="card-premium">
        <div style="margin-bottom: 20px;">
            <div
                style="width: 48px; height: 48px; background: var(--slate-50); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; color: var(--primary);">
                <i class="ph-duotone ph-package" style="font-size: 24px;"></i>
            </div>
            <h3 class="font-bold text-lg" style="margin-bottom: 8px;">Inventory</h3>
            <p class="text-slate-500" style="font-size: 14px;">Monitor stock levels and identify low-stock items
                immediately.</p>
        </div>

        <div id="inventory-output"></div> <!-- Dynamic Content Target -->

        {% if has_access %}
        <button class="btn-secondary" style="width: 100%; justify-content: center;"
            onclick="handleAction('updateInventory', this)">
            Check Status <i class="ph-bold ph-arrow-right"></i>
        </button>
        {% else %}
        <button class="btn-secondary" style="width: 100%; justify-content: center; opacity: 0.6;" disabled>
            <i class="ph-fill ph-lock-key"></i> Locked
        </button>
        {% endif %}
    </div>

    <!-- Analytics -->
    <div class="card-premium">
        <div style="margin-bottom: 20px;">
            <div
                style="width: 48px; height: 48px; background: var(--slate-50); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; color: var(--primary);">
                <i class="ph-duotone ph-chart-line-up" style="font-size: 24px;"></i>
            </div>
            <h3 class="font-bold text-lg" style="margin-bottom: 8px;">Analytics</h3>
            <p class="text-slate-500" style="font-size: 14px;">Generate real-time revenue reports and sales velocity
                metrics.</p>
        </div>

        <div id="report-output"></div> <!-- Dynamic Content Target -->

        {% if has_access %}
        <button class="btn-secondary" style="width: 100%; justify-content: center;"
            onclick="handleAction('generateReport', this)">
            Generate Report <i class="ph-bold ph-arrow-right"></i>
        </button>
        {% else %}
        <button class="btn-secondary" style="width: 100%; justify-content: center; opacity: 0.6;" disabled>
            <i class="ph-fill ph-lock-key"></i> Locked
        </button>
        {% endif %}
    </div>

</div>

<!-- JavaScript for Dynamic Actions -->
<script>
    async function handleAction(actionName, btnElement) {
        // Visual Feedback
        const originalText = btnElement.innerHTML;
        btnElement.innerHTML = '<i class="ph-bold ph-spinner" style="animation: spin 1s linear infinite;"></i> Loading...';
        btnElement.disabled = true;

        try {
            // Determine endpoint
            let endpoint = '';
            let targetId = '';

            if (actionName === 'processOrders') { endpoint = '/process_orders'; targetId = 'orders-output'; }
            if (actionName === 'updateInventory') { endpoint = '/update_inventory'; targetId = 'inventory-output'; }
            if (actionName === 'generateReport') { endpoint = '/generate_report'; targetId = 'report-output'; }

            // Add shop param
            const urlParams = new URLSearchParams(window.location.search);
            const shop = urlParams.get('shop') || '';
            if (shop) endpoint += '?shop=' + shop;

            const response = await fetch(endpoint);
            const data = await response.json();

            if (data.success && data.html) {
                // Determine target container (inject above button)
                const container = document.getElementById(targetId);
                if (container) {
                    container.innerHTML = data.html;
                    container.style.marginBottom = '20px';
                }
            } else {
                alert('Action failed: ' + (data.error || 'Unknown error'));
            }

        } catch (error) {
            console.error(error);
            alert('Error executing action');
        } finally {
            // Restore button
            btnElement.innerHTML = originalText;
            btnElement.disabled = false;
        }
    }
</script>

{% endblock %}