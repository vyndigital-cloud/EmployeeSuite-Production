{% extends "layout_polaris.html" %}

{% block extra_head %}
<style>
    .page-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-main);
    }

    .page-subtitle {
        font-size: 14px;
        color: var(--text-sub);
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text-main);
        font-size: 14px;
    }

    .form-input,
    .form-select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        background: #fff;
        color: var(--text-main);
        box-sizing: border-box;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 128, 96, 0.1);
    }

    .report-item {
        background: #f9fafb;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .report-info h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .report-info p {
        font-size: 14px;
        color: var(--text-sub);
        margin: 2px 0;
    }
</style>
{% endblock %}

{% block content %}
<header class="header-section">
    <h1 class="main-title">Scheduled Reports</h1>
    <p class="sub-title">Automatically receive reports via Email or SMS at your preferred time.</p>
</header>

<div id="alert-container"></div>

<div class="card">
    <div
        style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border);">
        <div class="card-icon"><i class="ph-bold ph-plus"></i></div>
        <div class="card-title" style="margin: 0; font-size: 16px;">Create New Scheduled Report</div>
    </div>

    <form id="create-report-form">
        <div class="form-group">
            <label class="form-label">Report Type</label>
            <select name="report_type" class="form-select" required>
                <option value="all">All Reports (Orders, Inventory, Revenue)</option>
                <option value="orders">Orders Only</option>
                <option value="inventory">Inventory Only</option>
                <option value="revenue">Revenue Only</option>
            </select>
        </div>

        <div class="cards-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 0;">
            <div class="form-group">
                <label class="form-label">Frequency</label>
                <select name="frequency" class="form-select" required>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Delivery Time</label>
                <input type="time" name="delivery_time" class="form-input" value="09:00" required>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Delivery Email</label>
            <input type="email" name="delivery_email" class="form-input" placeholder="your@email.com" required>
        </div>

        <div style="margin-top: 32px; text-align: right;">
            <button type="submit" class="btn-primary" id="create-btn"
                style="width: auto; display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;">
                <span>Create Scheduled Report</span>
                <i class="ph-bold ph-paper-plane-right"></i>
            </button>
        </div>
    </form>
</div>

<div style="margin-top: 40px;">
    <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
        <i class="ph-bold ph-list-dashes"></i> Active Scheduled Reports
    </h3>
    <div id="reports-container">
        <div class="card" style="text-align: center; padding: 40px; color: var(--text-sub);">
            <i class="ph-duotone ph-spinner ph-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
            Loading reports...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type) {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        // Using updated dashboard.css styling if available or inline styles
        alert.style.cssText = type === 'success'
            ? 'padding: 16px; border-radius: 8px; margin-bottom: 24px; background: #ecfdf5; border: 1px solid #6ee7b7; color: #065f46; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm);'
            : 'padding: 16px; border-radius: 8px; margin-bottom: 24px; background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm);';

        const icon = type === 'success' ? '<i class="ph-bold ph-check-circle"></i>' : '<i class="ph-bold ph-warning-circle"></i>';
        alert.innerHTML = icon + '<span>' + message + '</span>';

        container.innerHTML = '';
        container.appendChild(alert);
        // Scroll to alert
        alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => alert.remove(), 5000);
    }

    async function loadReports() {
        try {
            const response = await fetch('/api/scheduled-reports');
            const data = await response.json();

            const container = document.getElementById('reports-container');

            if (!data.reports || data.reports.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px; color: var(--text-sub);">
                        <i class="ph-duotone ph-calendar-x" style="font-size: 32px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <p>No scheduled reports yet.</p>
                    </div>`;
                return;
            }

            container.innerHTML = data.reports.map(report => `
                <div class="card" style="padding: 24px; display: flex; align-items: center; gap: 24px; margin-bottom: 20px;">
                    <div class="card-icon" style="margin-bottom: 0; width: 48px; height: 48px; font-size: 24px;"><i class="ph-bold ph-file-text"></i></div>
                    
                    <div style="flex: 1;">
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text-main); margin-bottom: 4px;">
                            ${report.report_type.charAt(0).toUpperCase() + report.report_type.slice(1)} Report
                        </h3>
                        <div style="font-size: 14px; color: var(--text-sub); display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <span style="display: flex; align-items: center; gap: 6px;"><i class="ph-bold ph-clock"></i> ${report.frequency.charAt(0).toUpperCase() + report.frequency.slice(1)} @ ${report.delivery_time}</span>
                            <span style="display: flex; align-items: center; gap: 6px;"><i class="ph-bold ph-envelope-simple"></i> ${report.delivery_email}</span>
                        </div>
                    </div>

                    <button class="nav-btn" style="color: #ef4444; border-color: #fecaca; background: #fff; padding: 10px 16px;" onclick="deleteReport(${report.id})">
                        <i class="ph-bold ph-trash"></i> Delete
                    </button>
                </div>
            `).join('');
        } catch (error) {
            document.getElementById('reports-container').innerHTML =
                '<div class="card" style="padding: 20px; color: #ef4444; text-align: center;">Error loading reports.</div>';
        }
    }

    async function deleteReport(id) {
        if (!confirm('Are you sure you want to delete this scheduled report?')) return;

        try {
            const response = await fetch(`/api/scheduled-reports/${id}`, { method: 'DELETE' });
            const data = await response.json();

            if (data.success) {
                showAlert('Scheduled report deleted successfully', 'success');
                loadReports();
            } else {
                showAlert(data.error || 'Failed to delete report', 'error');
            }
        } catch (error) {
            showAlert('Error deleting report.', 'error');
        }
    }

    document.getElementById('create-report-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = e.target;
        const btn = document.getElementById('create-btn');
        const originalContent = btn.innerHTML;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        btn.disabled = true;
        btn.innerHTML = 'Creating... <i class="ph-bold ph-spinner ph-spin"></i>';

        try {
            const response = await fetch('/api/scheduled-reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                showAlert('Scheduled report created successfully!', 'success');
                form.reset();
                loadReports();
            } else {
                showAlert(result.error || 'Failed to create scheduled report', 'error');
            }
        } catch (error) {
            showAlert('Error creating scheduled report.', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    });

    loadReports();
</script>
{% endblock %}