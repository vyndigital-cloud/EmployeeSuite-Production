{% extends "layout_polaris.html" %}

{% block extra_head %}
<style>
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 100px;
        font-size: 13px;
        font-weight: 500;
    }

    .status-active {
        background: #ecfdf5;
        color: #065f46;
    }

    .sos-btn {
        background: #ef4444;
        color: white;
        border: none;
        box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.3);
        border-radius: 8px;
        padding: 10px 20px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .sos-btn:hover {
        background: #dc2626;
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<div id="alert-container"></div>

<div class="dashboard-header-row">
    <div>
        <div class="page-title">Automation Center</div>
        <div class="page-subtitle">
            Your store is being monitored. Scheduled reports are running.
        </div>
        <div class="status-badge status-active" style="margin-top: 12px;">
            <i class="ph-bold ph-pulse"></i> Systems Active
        </div>
    </div>
</div>

<!-- Quick Stats Section -->
<div class="quick-stats-grid" id="quick-stats-section" style="display: none; margin-top: 32px; margin-bottom: 24px;">
    <div class="quick-stat-card">
        <div class="quick-stat-header">
            <i class="ph-duotone ph-package" style="font-size: 18px; color: var(--primary);"></i>
            <span>Pending Orders</span>
        </div>
        <div class="quick-stat-value" id="qs-pending-orders">-</div>
        <div class="quick-stat-footer">Need your attention</div>
    </div>
    <div class="quick-stat-card">
        <div class="quick-stat-header">
            <i class="ph-duotone ph-tag" style="font-size: 18px; color: var(--primary);"></i>
            <span>Total Products</span>
        </div>
        <div class="quick-stat-value" id="qs-total-products">-</div>
        <div class="quick-stat-footer">In your store</div>
    </div>
    <div class="quick-stat-card">
        <div class="quick-stat-header">
            <i class="ph-duotone ph-warning-circle" id="qs-low-stock-icon"
                style="font-size: 18px; color: var(--primary);"></i>
            <span>Low Stock</span>
        </div>
        <div class="quick-stat-value" id="qs-low-stock">-</div>
        <div class="quick-stat-footer" id="qs-low-stock-text">Checking...</div>
    </div>
</div>

<!-- SOS and Configuration Actions -->
<div class="card" style="margin-top: 24px;">
    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
        <button onclick="triggerSOS()" id="sos-btn" class="sos-btn"
            style="display: inline-flex; align-items: center; gap: 10px;">
            <i class="ph-bold ph-lightning"></i> Send Instant SOS Report
        </button>

        <button onclick="openPage('/features/scheduled-reports')" class="btn-secondary"
            style="display: inline-flex; align-items: center; gap: 8px;">
            <i class="ph-bold ph-calendar-check"></i> Configure Schedule
        </button>
    </div>
    <p style="font-size: 13px; color: var(--text-sub); margin-top: 16px; display: flex; align-items: center; gap: 6px;">
        <i class="ph-bold ph-info"></i> SOS Report sends a comprehensive snapshot to your email immediately.
    </p>
</div>

<!-- Manual Verification Section -->
<div style="margin-top: 40px;">
    <h3
        style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: var(--text-main); display: flex; align-items: center; gap: 8px;">
        <i class="ph-bold ph-eye"></i> Manual Verification
    </h3>

    <div class="card">
        <div
            style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px;">
            <div>
                <h4 style="margin: 0; font-size: 16px;">Live Dashboard</h4>
                <p style="margin: 4px 0 0; color: var(--text-sub); font-size: 14px;">Manually load current data for
                    on-screen inspection.</p>
            </div>
            <button class="btn-secondary" onclick="loadDashboard()" id="load-btn" style="width: auto;">
                <span id="load-btn-text">Load Live Data</span>
                <i class="ph-bold ph-arrows-clockwise"></i>
            </button>
        </div>

        <div id="dashboard-content">
            <div style="text-align: center; padding: 40px 20px; color: var(--text-sub);">
                <i class="ph-duotone ph-chart-polar" style="font-size: 40px; margin-bottom: 16px; opacity: 0.5;"></i>
                <p style="font-size: 15px;">Data is hidden to keep your workspace clean.</p>
                <p style="font-size: 14px;">Click "Load Live Data" to inspect.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showAlert(message, type) {
        const container = document.getElementById('alert-container');
        const alert = document.createElement('div');
        alert.style.cssText = type === 'success'
            ? 'padding: 16px; border-radius: 8px; margin-bottom: 24px; background: #ecfdf5; border: 1px solid #6ee7b7; color: #065f46; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm);'
            : type === 'error'
                ? 'padding: 16px; border-radius: 8px; margin-bottom: 24px; background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm);'
                : 'padding: 16px; border-radius: 8px; margin-bottom: 24px; background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm);';

        let icon = '<i class="ph-bold ph-info"></i>';
        if (type === 'success') icon = '<i class="ph-bold ph-check-circle"></i>';
        if (type === 'error') icon = '<i class="ph-bold ph-warning-circle"></i>';

        alert.innerHTML = icon + '<span>' + message + '</span>';
        container.innerHTML = '';
        container.appendChild(alert);
    }

    async function triggerSOS() {
        const btn = document.getElementById('sos-btn');
        const originalHTML = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<i class="ph-bold ph-spinner ph-spin"></i> Sending...';

        try {
            const response = await fetch('/features/api/trigger-report-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report_type: 'all' })
            });
            const data = await response.json();

            if (data.success) {
                showAlert('SOS Request Received: Check your email for the report.', 'success');
            } else {
                showAlert(data.error || 'Failed to send SOS report.', 'error');
            }
        } catch (e) {
            showAlert('Communication error. Please try again.', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    }

    // Reuse existing dashboard logic for manual load
    function renderReportSection(title, data, isError) {
        if (!data) return '';

        if (isError || data.success === false) {
            return `
                <div style="padding: 20px; background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; margin-bottom: 24px;">
                    <h3 style="color: #991b1b; margin-bottom: 8px; font-size: 16px; font-weight: 600;">${title}</h3>
                    <p style="color: #7f1d1d; margin-bottom: 12px; font-size: 14px;">${data.error || data.message || 'Error loading data'}</p>
                </div>
            `;
        }

        const html = data.message || data.html || JSON.stringify(data, null, 2);
        return `
            <div style="margin-bottom: 32px;">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                    ${title}
                </h3>
                <div style="background: #fafafa; border: 1px solid var(--border); border-radius: 8px; padding: 20px; overflow-x: auto;">
                    ${html}
                </div>
            </div>
        `;
    }

    async function loadDashboard() {
        const content = document.getElementById('dashboard-content');
        const btn = document.getElementById('load-btn');
        const btnText = document.getElementById('load-btn-text');

        content.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
                <i class="ph-duotone ph-spinner ph-spin" style="font-size: 32px; color: var(--primary); margin-bottom: 16px;"></i>
                <p style="color: var(--text-sub);">Fetching live store data...</p>
            </div>`;

        btn.disabled = true;
        btnText.textContent = 'Loading...';
        btn.querySelector('i').className = 'ph-bold ph-spinner ph-spin';

        try {
            const response = await fetch('/features/api/dashboard/comprehensive');
            const data = await response.json();

            if (data.success || (data.orders || data.inventory || data.revenue)) {
                // Populate Quick Stats
                const qsSection = document.getElementById('quick-stats-section');
                if (qsSection) {
                    const pendingOrders = data.orders?.data?.pending_orders || 0;
                    const totalProducts = data.inventory?.data?.total_products || 0;
                    const lowStock = data.inventory?.data?.low_stock_items || 0;

                    const pendingVal = document.getElementById('qs-pending-orders');
                    if (pendingVal) pendingVal.textContent = pendingOrders;

                    const productsVal = document.getElementById('qs-total-products');
                    if (productsVal) productsVal.textContent = totalProducts;

                    const lowStockVal = document.getElementById('qs-low-stock');
                    const lowStockIcon = document.getElementById('qs-low-stock-icon');
                    const lowStockText = document.getElementById('qs-low-stock-text');

                    if (lowStockVal) {
                        lowStockVal.textContent = lowStock;
                        if (lowStock > 0) {
                            lowStockVal.style.color = '#dc2626';
                            if (lowStockIcon) lowStockIcon.style.color = '#dc2626';
                            if (lowStockText) lowStockText.textContent = 'Need restocking';
                        } else {
                            lowStockVal.style.color = 'inherit';
                            if (lowStockIcon) lowStockIcon.style.color = 'var(--primary)';
                            if (lowStockText) lowStockText.textContent = 'All good';
                        }
                    }
                    qsSection.style.display = 'grid';
                }
                let html = '';

                if (data.orders) html += renderReportSection('Orders', data.orders, false);
                if (data.inventory) html += renderReportSection('Inventory', data.inventory, false);
                if (data.revenue) html += renderReportSection('Revenue', data.revenue, false);

                if (data.errors && data.errors.length > 0) {
                    data.errors.forEach(error => {
                        html += renderReportSection(error.type + ' Error', { error: error.error }, true);
                    });
                }

                if (!html) html = '<p style="text-align:center; padding:20px;">No data available.</p>';
                content.innerHTML = html;

                if (!data.errors || data.errors.length === 0) showAlert('Live data loaded.', 'success');
                else showAlert('Data loaded with some errors.', 'error');
            } else {
                const errorMsg = data.error || 'Failed to load dashboard';
                content.innerHTML = `<p style="text-align:center; color:red; padding:20px;">${errorMsg}</p>`;
                showAlert(errorMsg, 'error');
            }
        } catch (error) {
            content.innerHTML = `<p style="text-align:center; color:red; padding:20px;">Connection Error</p>`;
            showAlert('Error loading dashboard.', 'error');
        } finally {
            btn.disabled = false;
            btnText.textContent = 'Reload Live Data';
            btn.querySelector('i').className = 'ph-bold ph-arrows-clockwise';
        }
    }
</script>
{% endblock %}