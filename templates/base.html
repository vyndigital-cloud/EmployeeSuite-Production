<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ title or 'Employee Suite' }}</title>

        <!-- Shopify App Bridge -->
        <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
        <script src="https://cdn.shopify.com/shopifycloud/app-bridge/latest/environments/production.js"></script>

        <!-- Shopify Polaris -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/@shopify/polaris@10.0.0/build/esm/styles.css"
        />
        <script src="https://unpkg.com/@shopify/polaris@10.0.0/build/esm/polaris.min.js"></script>

        <!-- Custom Global Styles -->
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}"
        />

        <!-- Phosphor Icons -->
        <script src="https://unpkg.com/@phosphor-icons/web"></script>

        <!-- Inline critical overrides if needed -->
        <style>
            .Polaris-Frame {
                min-height: 100vh;
            }
        </style>
    </head>

    <body>
        <div id="app">
            <!-- Loading state -->
            <div id="loading" class="loading-container">
                <div class="Polaris-Spinner Polaris-Spinner--sizeLarge"></div>
            </div>

            <!-- Error state -->
            <div id="error" class="error-container" style="display: none">
                <h2>Something went wrong</h2>
                <p id="error-message">Please try refreshing the page.</p>
            </div>

            <!-- Main content -->
            <div id="main-content" style="display: none">
                {% block content %}{% endblock %}
            </div>
        </div>

        <script>
            // Initialize App Bridge
            let app;
            let redirect;

            function initializeAppBridge() {
                try {
                    // Get shop from URL or use default
                    const urlParams = new URLSearchParams(
                        window.location.search,
                    );
                    const shop =
                        urlParams.get("shop") ||
                        '{{ shop|default("") }}' ||
                        urlParams.get("host");

                    if (!shop) {
                        throw new Error("Shop parameter not found");
                    }

                    // Create App Bridge app
                    app = window.shopify.createApp({
                        apiKey: "{{ SHOPIFY_API_KEY }}",
                        host: shop,
                        forceRedirect: true,
                    });

                    // Create redirect utility
                    redirect = window.shopify.appRedirect(app);

                    // Show main content
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("main-content").style.display =
                        "block";

                    console.log("App Bridge initialized successfully");
                } catch (error) {
                    console.error("Failed to initialize App Bridge:", error);
                    showError("Failed to initialize app: " + error.message);
                }
            }

            function showError(message) {
                document.getElementById("loading").style.display = "none";
                document.getElementById("error").style.display = "block";
                document.getElementById("error-message").textContent = message;
            }

            // Initialize when DOM is ready
            document.addEventListener("DOMContentLoaded", initializeAppBridge);

            // Global error handler
            window.addEventListener("error", function (event) {
                console.error("Global error:", event.error);
                showError("An unexpected error occurred");
            });

            // Make app and redirect available globally
            window.appBridge = { app, redirect };
        </script>

        {% block scripts %}{% endblock %}
    </body>
</html>
