<!DOCTYPE html>
<html>

<head>
    <title>Authenticating...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f6f6f7;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .auth-bridge {
            text-align: center;
            padding: 32px;
        }

        .spinner {
            border: 3px solid #e1e3e5;
            border-top: 3px solid #5c6ac4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .text {
            color: #637381;
            font-size: 15px;
            margin-bottom: 8px;
        }

        .subtext {
            color: #919eab;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <div class="auth-bridge">
        <div class="spinner"></div>
        <div class="text">Securing your connection...</div>
        <div class="subtext">This will only take a moment</div>
    </div>

    <script>
        (async function() {
            const startTime = Date.now();
            
            try {
                console.log("üîê Auth Bridge: Starting handshake...");
                
                // OPTIMIZATION 1: Shorter wait, fail fast
                let attempts = 0;
                const maxAttempts = 20; // Reduced from implied longer wait
                
                while (!window.shopify && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 50)); // Reduced from 100ms
                    attempts++;
                }
                
                if (!window.shopify || typeof window.shopify.idToken !== 'function') {
                    throw new Error('App Bridge not available after ' + (attempts * 50) + 'ms');
                }
                
                console.log(`‚úÖ App Bridge ready in ${attempts * 50}ms`);
                
                // OPTIMIZATION 2: Get token with timeout
                const tokenPromise = window.shopify.idToken();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Token fetch timeout')), 2000)
                );
                
                const token = await Promise.race([tokenPromise, timeoutPromise]);
                
                if (token) {
                    const elapsed = Date.now() - startTime;
                    console.log(`‚úÖ Token acquired in ${elapsed}ms`);
                    
                    // OPTIMIZATION 3: Use replace instead of reload for faster navigation
                    const url = new URL(window.location.href);
                    url.searchParams.set('id_token', token);
                    
                    window.location.replace(url.toString());
                } else {
                    throw new Error('Failed to obtain session token');
                }
                
            } catch (error) {
                const elapsed = Date.now() - startTime;
                console.error(`‚ùå Auth Bridge failed after ${elapsed}ms:`, error);
                
                // FALLBACK: Show error message
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif;">
                        <div style="text-align: center;">
                            <p style="color: #bf0711;">‚ùå Authentication Failed</p>
                            <p style="font-size: 12px; color: #666;">Error: ${error.message}</p>
                            <button onclick="window.location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #008060; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Retry
                            </button>
                        </div>
                    </div>
                `;
            }
        })();
    </script>
</body>

</html>