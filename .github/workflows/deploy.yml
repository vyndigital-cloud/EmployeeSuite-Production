name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Wait for CI tests to pass first
  wait-for-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI to pass
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.sha }}
          check-name: 'test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  deploy:
    runs-on: ubuntu-latest
    needs: wait-for-ci
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "üöÄ Deploying to Render..."
        curl -X POST \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{}'
        
    - name: Wait for deployment
      run: |
        echo "‚è≥ Waiting 60 seconds for deployment to complete..."
        sleep 60

    - name: Run post-deployment smoke test
      env:
        PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
      run: |
        echo "üîç Testing production deployment..."
        
        # Test home route
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PRODUCTION_URL/")
        if [ "$STATUS" = "500" ]; then
          echo "‚ùå PRODUCTION DEPLOYMENT FAILED - Home route returned 500"
          echo "üîÑ Triggering rollback..."
          exit 1
        fi
        
        # Test auth callback route
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PRODUCTION_URL/auth/callback")
        if [ "$STATUS" = "500" ]; then
          echo "‚ùå PRODUCTION DEPLOYMENT FAILED - Auth callback returned 500"
          echo "üîÑ Triggering rollback..."
          exit 1
        fi
        
        echo "‚úÖ Production deployment successful!"
    
    - name: Rollback on failure
      if: failure()
      run: |
        echo "‚ùå DEPLOYMENT FAILED - PRODUCTION RETURNED 500 ERROR"
        echo "‚ö†Ô∏è IMMEDIATELY ROLLBACK FROM RENDER DASHBOARD"
        exit 1
